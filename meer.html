<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هاوبەشکردنی پەڕگەکان - کوردی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ==========================================
        //  بەشی ڕێکخستنی فایەربەیس (بۆ کاتی دابەزاندن)
        // ==========================================
        // ئەگەر فایلەکە دابەزێنیت، زانیارییەکانی خۆت لێرە دابنێ:
        // تێبینی: ناوی ئەم گۆڕاوە دەبێت MANUAL_CONFIG بێت نەک firebaseConfig
        const MANUAL_CONFIG = {
            apiKey: "AIzaSyBHxuOA6uuX1EZGse5_JOHc3WMjvPywLD4",
            authDomain: "prsyar-c93dd.firebaseapp.com",
            projectId: "prsyar-c93dd",
            storageBucket: "prsyar-c93dd.firebasestorage.app",
            messagingSenderId: "623772510800",
            appId: "1:623772510800:web:cc49fc9bbd9ed9c170ff55",
            measurementId: "G-7KLKMNVFHC"
        };
        // ==========================================

        // Global Variables
        window.db = null;
        window.storage = null;
        window.auth = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-share-app';
        window.unsubscribeFiles = null;

        // Initialize Firebase
        const initFirebase = async () => {
            let firebaseConfig;

            // 1. Try to use the Chat Environment Config (Automatic)
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } 
            // 2. Fallback to Manual Config (For when you download the file)
            // لێرەدا کۆدەکە سەیری MANUAL_CONFIG دەکات
            else if (typeof MANUAL_CONFIG !== 'undefined' && MANUAL_CONFIG.apiKey !== "YOUR_API_KEY_HERE") {
                firebaseConfig = MANUAL_CONFIG;
            } 
            else {
                console.warn("No Firebase config found.");
                alert("تێبینی: بۆ ئەوەی ئەم فایلە لەسەر مۆبایلەکەت کار بکات، دەبێت زانیاری Firebaseـی خۆت لە ناو کۆدەکەدا دابنێیت.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.storage = getStorage(app);

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                };
                
                await initAuth();

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        initRoom();
                    }
                });
            } catch (err) {
                console.error("Firebase Init Error:", err);
                alert("هەڵە لە بەستنەوەی فایەربەیس: " + err.message);
            }
        };

        initFirebase();

        // --- Logic Functions ---

        function initRoom() {
            let savedRoom = localStorage.getItem('share_room_id');
            if (!savedRoom) {
                savedRoom = Math.floor(1000 + Math.random() * 9000).toString();
                localStorage.setItem('share_room_id', savedRoom);
            }
            document.getElementById('room-code-input').value = savedRoom;
            connectToRoom(savedRoom);
        }

        window.updateRoom = function() {
            const newCode = document.getElementById('room-code-input').value.trim();
            if (newCode && newCode.length > 0) {
                localStorage.setItem('share_room_id', newCode);
                connectToRoom(newCode);
                
                const btn = document.getElementById('refresh-btn');
                btn.classList.add('text-green-600');
                setTimeout(() => btn.classList.remove('text-green-600'), 1000);
            }
        }

        function connectToRoom(roomId) {
            if (window.unsubscribeFiles) {
                window.unsubscribeFiles();
            }

            const filesRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'shared_files');
            
            document.getElementById('loader').classList.remove('hidden');

            window.unsubscribeFiles = onSnapshot(filesRef, (snapshot) => {
                document.getElementById('loader').classList.add('hidden');
                const files = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (String(data.roomId).trim() === String(roomId).trim()) {
                        files.push({ id: doc.id, ...data });
                    }
                });
                
                files.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderFiles(files);
                updateStats(files);
            }, (error) => {
                console.error("Error fetching files:", error);
                document.getElementById('loader').classList.add('hidden');
            });
        }

        window.handleFiles = async function(fileList) {
            const files = [...fileList];
            
            const inputCode = document.getElementById('room-code-input').value.trim();
            const activeRoom = localStorage.getItem('share_room_id');

            if (inputCode !== activeRoom) {
                localStorage.setItem('share_room_id', inputCode);
                connectToRoom(inputCode);
            }
            
            const roomId = inputCode;
            
            if (!window.auth || !window.auth.currentUser) {
                alert("تكایە چاوەڕێ بە تا پەیوەست دەبێت بە ئینتەرنێتەوە...");
                return;
            }

            for (const file of files) {
                uploadSingleFile(file, roomId);
            }
        }

        async function uploadSingleFile(file, roomId) {
            if (!window.storage) return;

            const progressId = 'prog-' + Math.random().toString(36).substr(2, 9);
            showUploadingState(file.name, progressId);

            try {
                const storageRef = ref(window.storage, `artifacts/${window.appId}/public/${roomId}/${Date.now()}_${file.name}`);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateProgress(progressId, progress);
                    }, 
                    (error) => {
                        console.error("Upload failed", error);
                        removeProgress(progressId);
                        alert("هەڵە لە بارکردن: " + error.message);
                    }, 
                    async () => {
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            await addDoc(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'shared_files'), {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                url: downloadURL,
                                roomId: String(roomId).trim(),
                                createdAt: serverTimestamp(),
                                storagePath: uploadTask.snapshot.ref.fullPath
                            });
                            
                            removeProgress(progressId);
                        } catch (firestoreError) {
                            console.error("Firestore Error:", firestoreError);
                            removeProgress(progressId);
                        }
                    }
                );
            } catch (err) {
                console.error(err);
                removeProgress(progressId);
                alert("هەڵەیەکی نەزانراو: " + err.message);
            }
        }

        // --- Delete Functions ---
        
        // Internal function to perform deletion
        const performDelete = async (id, storagePath) => {
            try {
                // 1. Delete from Firestore
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'shared_files', id));
                
                // 2. Delete from Storage
                if (storagePath) {
                    const fileRef = ref(window.storage, storagePath);
                    await deleteObject(fileRef).catch(e => console.log("Storage delete error (might already be gone):", e));
                }
            } catch (e) {
                console.error("Error deleting:", e);
            }
        }

        // Manual Delete
        window.deleteFile = async function(id, storagePath) {
            if(!confirm('دڵنیایت لە سڕینەوەی ئەم پەڕگەیە؟')) return;
            await performDelete(id, storagePath);
        }

        // Download AND Delete
        window.downloadAndDelete = function(url, id, storagePath) {
            // 1. Trigger Download
            window.open(url, '_blank');

            // 2. Show small notification
            const notification = document.createElement('div');
            notification.className = "fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm animate-bounce";
            notification.innerHTML = '<i class="fa-solid fa-trash-can ml-2"></i> فایلەکە سڕایەوە';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);

            // 3. Delete Immediately
            setTimeout(() => {
                performDelete(id, storagePath);
            }, 1000);
        }

        // --- UI Functions ---
        function showUploadingState(filename, id) {
            const container = document.getElementById('upload-progress-container');
            const div = document.createElement('div');
            div.id = id;
            div.className = "bg-white p-3 rounded-lg shadow-sm border border-blue-100 mb-2 flex items-center justify-between";
            div.innerHTML = `
                <div class="flex items-center space-x-3 space-x-reverse truncate">
                    <i class="fa-solid fa-spinner fa-spin text-blue-500"></i>
                    <span class="text-sm text-slate-700 truncate max-w-[150px]">${filename}</span>
                </div>
                <div class="w-24 bg-gray-200 rounded-full h-2.5">
                    <div class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            `;
            container.appendChild(div);
            container.classList.remove('hidden');
        }

        function updateProgress(id, percent) {
            const el = document.getElementById(id);
            if (el) {
                el.querySelector('.progress-bar').style.width = percent + '%';
            }
        }

        function removeProgress(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
            
            const container = document.getElementById('upload-progress-container');
            if (container.children.length === 0) container.classList.add('hidden');
        }

        function renderFiles(files) {
            const fileList = document.getElementById('file-list');
            const emptyState = document.getElementById('empty-state');

            Array.from(fileList.children).forEach(child => {
                if (child.id !== 'empty-state') child.remove();
            });

            if (files.length === 0) {
                emptyState.style.display = 'block';
                return;
            } else {
                emptyState.style.display = 'none';
            }

            files.forEach(file => {
                const fileType = getFileType(file.type || '');
                const fileSize = formatBytes(file.size);
                const fileIcon = getFileIcon(fileType);
                const iconColor = getIconColor(fileType);
                const dateStr = file.createdAt ? new Date(file.createdAt.seconds * 1000).toLocaleTimeString('ckb-IQ') : '...';

                const div = document.createElement('div');
                div.className = 'file-card bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-3 group relative';
                
                div.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <div class="flex items-center space-x-3 space-x-reverse overflow-hidden">
                            <div class="w-10 h-10 ${iconColor} bg-opacity-10 rounded-lg flex items-center justify-center flex-shrink-0 text-lg">
                                <i class="${fileIcon}"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-bold text-slate-800 truncate max-w-[150px]" title="${file.name}">${file.name}</p>
                                <p class="text-[10px] text-slate-500">${fileSize} • ${dateStr}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mt-1 border-t border-slate-50 pt-3">
                        <button onclick="downloadAndDelete('${file.url}', '${file.id}', '${file.storagePath}')" class="flex-1 bg-red-50 hover:bg-red-100 text-red-600 text-xs font-bold py-2 rounded-lg text-center transition flex items-center justify-center gap-2 border border-red-200">
                            <i class="fa-solid fa-download"></i> داگرتن و سڕینەوە
                        </button>
                    </div>
                `;
                fileList.appendChild(div);
            });
        }

        // Helper Logic
        function updateStats(files) {
            document.getElementById('total-count').innerText = files.length;
            document.getElementById('image-count').innerText = files.filter(f => (f.type || '').startsWith('image/')).length;
            document.getElementById('video-count').innerText = files.filter(f => (f.type || '').startsWith('video/')).length;
            
            const totalBytes = files.reduce((acc, file) => acc + (file.size || 0), 0);
            document.getElementById('total-size').innerText = formatBytes(totalBytes);
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function getFileType(mime) {
            if (mime.startsWith('image/')) return 'image';
            if (mime.startsWith('video/')) return 'video';
            if (mime.startsWith('audio/')) return 'audio';
            if (mime.includes('pdf')) return 'pdf';
            return 'other';
        }

        function getFileIcon(type) {
            switch(type) {
                case 'image': return 'fa-regular fa-image text-purple-600';
                case 'video': return 'fa-solid fa-video text-orange-600';
                case 'audio': return 'fa-solid fa-music text-pink-600';
                case 'pdf': return 'fa-regular fa-file-pdf text-red-600';
                default: return 'fa-regular fa-file text-blue-600';
            }
        }

        function getIconColor(type) {
            switch(type) {
                case 'image': return 'bg-purple-500 text-purple-600';
                case 'video': return 'bg-orange-500 text-orange-600';
                case 'audio': return 'bg-pink-500 text-pink-600';
                case 'pdf': return 'bg-red-500 text-red-600';
                default: return 'bg-blue-500 text-blue-600';
            }
        }
    </script>
</body>
</html>
