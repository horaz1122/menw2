import React, { useState, useRef, useEffect } from 'react';
import { Send, Leaf, Sprout, Sun, Droplets, Info, User, Bot, MapPin, Clock, Heart, Sparkles, Phone } from 'lucide-react';

// Ù¾ÛŽÚ©Ù‡Ø§ØªÛ•ÛŒ ÙˆÛŽÙ†Û•ÛŒ Ø¨Û†Øª
const BotAvatar = () => {
  const [imgError, setImgError] = useState(false);

  if (imgError) {
    return (
      <div className="w-full h-full bg-gradient-to-br from-emerald-100 to-emerald-200 flex items-center justify-center">
        <Bot size={20} className="text-emerald-700" />
      </div>
    );
  }

  return (
    <img 
      src="mer.jpg" 
      alt="Bot" 
      className="w-full h-full object-cover" 
      onError={() => setImgError(true)} 
    />
  );
};

const PlantApp = () => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      text: "Ø³ÚµØ§Ùˆ! Ø¨Û•Ø®ÛŽØ±Ø¨ÛŽÙ† Ø¨Û† Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± ðŸŒ¿. \n\nÙ…Ù† Ù„ÛŽØ±Û•Ù… Ø¨Û† ÛŒØ§Ø±Ù…Û•ØªÛŒØ¯Ø§Ù†Øª. Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ù¾Ø±Ø³ÛŒØ§Ø± Ø¨Ú©Û•ÛŒØª Ø¯Û•Ø±Ø¨Ø§Ø±Û•ÛŒ:\nâ€¢ Ù†Ø±Ø®ÛŒ Ú¯ÙˆÚµÛ•Ú©Ø§Ù† ðŸ·ï¸\nâ€¢ Ú†Û†Ù†ÛŒÛ•ØªÛŒ Ø¦Ø§ÙˆØ¯Ø§Ù† ðŸ’§\nâ€¢ Ú©ÛŽØ´Û• Ùˆ Ù†Û•Ø®Û†Ø´ÛŒÛŒÛ•Ú©Ø§Ù† ðŸ‚",
      sender: 'bot',
      time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
    }
  ]);
  const [inputText, setInputText] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [headerImgError, setHeaderImgError] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const generateResponse = (text) => {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('Ø¦Ø§Ùˆ') || lowerText.includes('water')) {
      return "Ø¨Û† Ø¦Ø§ÙˆØ¯Ø§Ù†ØŒ Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ú•ÛŽØ³Ø§ Ø¦Û•ÙˆÛ•ÛŒÛ• Ù¾Û•Ù†Ø¬Û•Øª Ø¨Ø®Û•ÛŒØªÛ• Ù†Ø§Ùˆ Ø®Ø§Ú©Û•Ú©Û•ÙˆÛ• (Ù†Ø²ÛŒÚ©Û•ÛŒ Ù¢-Ù£ Ø³Ù…). Ø¦Û•Ú¯Û•Ø± ÙˆØ´Ú© Ø¨ÙˆÙˆØŒ Ø¦Ø§ÙˆÛŒ Ø¨Ø¯Û•. Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¦Ø§Ù…ÛŽØ±ÛŒ Ù¾ÛŽÙˆØ§Ù†ÛŒ Ø´ÛŽÛŒ Ø®Ø§Ú©Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ú©Ø§Ø±Û•Ú©Û•Øª Ø¦Ø§Ø³Ø§Ù† Ø¯Û•Ú©Ø§Øª.";
    } else if (lowerText.includes('Ø®Û†Ø±') || lowerText.includes('Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ')) {
      return "Ø²Û†Ø±Ø¨Û•ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Ø§Ù† Ø­Û•Ø²ÛŒØ§Ù† Ø¨Û• Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ù†Ø§Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ÛŒÛ•. Ø¦Û•Ú¯Û•Ø± Ø´ÙˆÛŽÙ†Û•Ú©Û•Øª ØªØ§Ø±ÛŒÚ©Û•ØŒ Ø¦ÛŽÙ…Û• Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ú•ÙˆÛ•Ú©ÛŒ ÙˆÛ•Ú© 'Ø²Ø§Ù…ÙÛ†Ù„ÛŒØ§' Ùˆ 'Ø³Ø§Ù†Ø³ÛŽÚ¤ÛŽØ±ÛŒØ§'Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ø¨Û•Ø±Ú¯Û•ÛŒ Ú©Û•Ù… Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ø¯Û•Ú¯Ø±Ù†.";
    } else if (lowerText.includes('Ø²Û•Ø±Ø¯') || lowerText.includes('Ù†Û•Ø®Û†Ø´ÛŒ')) {
      return "Ø²Û•Ø±Ø¯Ø¨ÙˆÙˆÙ†ÛŒ Ú¯Û•ÚµØ§ Ø²Û†Ø±Ø¬Ø§Ø± Ø¨Û•Ù‡Û†ÛŒ Ø²Û†Ø± Ø¦Ø§ÙˆØ¯Ø§Ù†Û•ÙˆÛ•ÛŒÛ• ðŸ’§. Ù‡Û•Ø±ÙˆÛ•Ù‡Ø§ Ø¯Û•Ú©Ø±ÛŽØª Ø¨Û•Ù‡Û†ÛŒ Ú©Û•Ù…ÛŒ Ø¦Ø§Ø³Ù† Ø¨ÛŽØª. Ø¦ÛŽÙ…Û• Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ø¬Û†Ø±ÛŒ Ù¾Û•ÛŒÙ† Ùˆ Ø¯Û•Ø±Ù…Ø§Ù†ÛŒ Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©Û•Ú•ÙˆÙˆÙ…Ø§Ù† Ù‡Û•ÛŒÛ•.";
    } else if (lowerText.includes('Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†') || lowerText.includes('Ø´ÙˆÛŽÙ†')) {
      return "ðŸ“ **Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±:** \nØ³Û•Ø±Û•ØªØ§ÛŒ Ø´Û•Ù‚Ø§Ù…ÛŒ Ø³Û•Ø±Û•Ú©ÛŒØŒ ØªÛ•Ù†ÛŒØ´Øª Ø¨Ø§Ø®Ú†Û•ÛŒ Ú¯Ø´ØªÛŒ. \n\nÚ†Ø§ÙˆÛ•Ú•ÛŽÛŒ Ù‡Ø§ØªÙ†ØªØ§Ù†ÛŒÙ†!";
    } else if (lowerText.includes('Ù†Ø±Ø®') || lowerText.includes('price')) {
      return "Ù†Ø±Ø®Û•Ú©Ø§Ù†Ù…Ø§Ù† Ø²Û†Ø± Ú¯ÙˆÙ†Ø¬Ø§ÙˆÙ†! ðŸ·ï¸\n\nðŸŸ¢ Ú©Ø§Ú©ØªÙˆØ³: Ù£,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\nðŸŸ¢ Ù¾Û•ØªÛ†Ø³: Ù¥,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\nðŸŸ¢ Ù…Û•ØªØ§Øª: Ù¡Ù¥,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\n\nØ³Û•Ø±Ø¯Ø§Ù†Ù…Ø§Ù† Ø¨Ú©Û• Ø¨Û† Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Û†ÙÛ•Ø±Û•Ú©Ø§Ù†.";
    } else if (lowerText.includes('Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…') || lowerText.includes('Ú©Ø±Ø§ÙˆÛ•')) {
      return "ðŸ•’ **Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…:**\nÙ‡Û•Ù…ÙˆÙˆ Ú•Û†Ú˜ÛŽÚ© Ù„Û• Ú©Ø§ØªÚ˜Ù…ÛŽØ± Ù¨ÛŒ Ø¨Û•ÛŒØ§Ù†ÛŒ ØªØ§ Ù¡Ù ÛŒ Ø´Û•Ùˆ Ú©Ø±Ø§ÙˆÛ•ÛŒÛ•.";
    } else if (lowerText.includes('Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ') || lowerText.includes('Ú˜Ù…Ø§Ø±Û•')) {
      return "ðŸ“ž Ø¨Û† Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ú©Ø±Ø¯Ù†: 07501234567";
    } else {
      return "Ù¾Ø±Ø³ÛŒØ§Ø±ÛŽÚ©ÛŒ Ø¨Ø§Ø´Û•! ðŸ¤” ØªÚ©Ø§ÛŒÛ• Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¨Ú©Û•ÛŒØª Ø¨Û† Ú•Ø§ÙˆÛŽÚ˜ÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ØŒ ÛŒØ§Ù† Ù¾Ø±Ø³ÛŒØ§Ø±Û•Ú©Û•Øª Ú•ÙˆÙˆÙ†ØªØ± Ø¨Ú©Û•ÛŒØªÛ•ÙˆÛ•ØŸ";
    }
  };

  const handleSend = (e) => {
    e.preventDefault();
    if (!inputText.trim()) return;

    const userMessage = {
      id: messages.length + 1,
      text: inputText,
      sender: 'user',
      time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
    };

    setMessages(prev => [...prev, userMessage]);
    setInputText("");
    setIsLoading(true);

    setTimeout(() => {
      const botResponse = {
        id: messages.length + 2,
        text: generateResponse(userMessage.text),
        sender: 'bot',
        time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
      };
      setMessages(prev => [...prev, botResponse]);
      setIsLoading(false);
    }, 1500);
  };

  return (
    // Main Wrapper
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-0 sm:p-6 font-sans text-slate-800" dir="rtl">
      
      {/* Mobile Frame Container */}
      <div className="w-full max-w-[420px] bg-white sm:rounded-[40px] shadow-2xl overflow-hidden h-[100dvh] sm:h-[850px] flex flex-col relative border-[6px] border-slate-900/5 ring-1 ring-slate-900/10">
        
        {/* Header - Glassmorphism Style */}
        <header className="bg-emerald-600/95 backdrop-blur-md text-white p-4 pt-6 pb-4 shadow-lg z-20 relative">
          <div className="absolute inset-0 bg-gradient-to-r from-emerald-600 to-teal-600 opacity-90"></div>
          
          {/* Decorative Pattern */}
          <div className="absolute top-0 right-0 p-4 opacity-10">
             <Leaf size={64} />
          </div>

          <div className="relative flex items-center gap-3">
            <div className="relative">
              <div className="w-12 h-12 rounded-full border-2 border-white/30 p-0.5 shadow-sm">
                <div className="w-full h-full rounded-full overflow-hidden bg-white">
                  {!headerImgError ? (
                    <img 
                      src="mer.jpg" 
                      alt="Mer Logo" 
                      className="w-full h-full object-cover"
                      onError={() => setHeaderImgError(true)}
                    />
                  ) : (
                    <div className="w-full h-full bg-emerald-50 flex items-center justify-center">
                       <Leaf size={20} className="text-emerald-600" />
                    </div>
                  )}
                </div>
              </div>
              <span className="absolute bottom-0 right-0 block w-3.5 h-3.5 bg-green-400 border-2 border-emerald-600 rounded-full animate-pulse"></span>
            </div>
            
            <div className="flex-1">
              <h1 className="text-lg font-bold flex items-center gap-1">
                Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±
                <Sparkles size={14} className="text-yellow-300" />
              </h1>
              <p className="text-emerald-100 text-xs opacity-90 flex items-center gap-1">
                Ù„ÛŽØ±Û•ÛŒÙ† Ø¨Û† Ø®Ø²Ù…Û•ØªÚ©Ø±Ø¯Ù†ÛŒ Ø³Ø±ÙˆØ´Øª
              </p>
            </div>
            
            <button className="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors backdrop-blur-sm">
              <Phone size={18} className="text-white" />
            </button>
          </div>
        </header>

        {/* Chat Area */}
        <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-[#f0f4f8] relative scroll-smooth">
          {/* Background Pattern */}
          <div className="absolute inset-0 opacity-[0.03]" 
               style={{backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23065f46' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`}}>
          </div>

          {/* Date Label */}
          <div className="flex justify-center">
            <span className="bg-slate-200/60 text-slate-500 text-[10px] px-3 py-1 rounded-full font-medium shadow-sm backdrop-blur-sm">
              Ø¦Û•Ù…Ú•Û†
            </span>
          </div>

          {messages.map((msg) => (
            <div
              key={msg.id}
              className={`flex items-end gap-2 group animate-in slide-in-from-bottom-2 duration-500 fade-in ${
                msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row'
              }`}
            >
              {/* Avatar */}
              <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 shadow-sm overflow-hidden border border-white ${
                msg.sender === 'user' ? 'bg-indigo-500 hidden' : 'bg-white'
              }`}>
                {msg.sender === 'bot' && <BotAvatar />}
              </div>
              
              {/* Message Bubble */}
              <div className={`max-w-[80%] flex flex-col ${
                  msg.sender === 'user' ? 'items-end' : 'items-start'
                }`}
              >
                <div
                  className={`px-4 py-2.5 text-[15px] shadow-sm relative ${
                    msg.sender === 'user'
                      ? 'bg-emerald-600 text-white rounded-2xl rounded-br-none'
                      : 'bg-white text-slate-700 rounded-2xl rounded-bl-none border border-slate-100'
                  }`}
                >
                  <div className="whitespace-pre-line leading-relaxed">
                    {msg.text}
                  </div>
                </div>
                {/* Time */}
                <span className="text-[10px] text-slate-400 mt-1 px-1">
                  {msg.time}
                </span>
              </div>
            </div>
          ))}
          
          {isLoading && (
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center shadow-sm">
                <Bot size={16} className="text-emerald-600" />
              </div>
              <div className="bg-white px-4 py-3 rounded-2xl rounded-bl-none shadow-sm border border-slate-100 flex gap-1.5 items-center">
                <span className="text-xs text-slate-400 ml-2">Ø¯Û•Ù†ÙˆÙˆØ³ÛŽØª</span>
                <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce"></span>
                <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce delay-100"></span>
                <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-bounce delay-200"></span>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} className="h-4" />
        </div>

        {/* Input Area */}
        <div className="bg-white p-3 border-t border-slate-100 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] z-20">
          
          {/* Quick Chips */}
          <div className="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide px-1">
             {[
               { icon: <MapPin size={14} />, text: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†", color: "bg-rose-50 text-rose-600 border-rose-100" },
               { icon: <Info size={14} />, text: "Ù†Ø±Ø®Û•Ú©Ø§Ù†", color: "bg-blue-50 text-blue-600 border-blue-100" },
               { icon: <Droplets size={14} />, text: "Ø¦Ø§ÙˆØ¯Ø§Ù†", color: "bg-cyan-50 text-cyan-600 border-cyan-100" },
               { icon: <Clock size={14} />, text: "Ø¯Û•ÙˆØ§Ù…", color: "bg-amber-50 text-amber-600 border-amber-100" },
             ].map((chip, idx) => (
               <button 
                key={idx}
                onClick={() => setInputText(chip.text)} 
                className={`flex items-center gap-1.5 text-xs font-semibold px-3 py-1.5 rounded-full transition-transform active:scale-95 border ${chip.color} shrink-0`}
               >
                 {chip.icon} {chip.text}
               </button>
             ))}
          </div>

          <form onSubmit={handleSend} className="flex gap-2 items-end">
            <div className="flex-1 bg-slate-100 rounded-[24px] border border-transparent focus-within:border-emerald-500 focus-within:bg-white focus-within:ring-2 focus-within:ring-emerald-100 transition-all flex items-center">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="Ù†Ø§Ù…Û•Ú©Û•Øª Ù„ÛŽØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..."
                className="w-full bg-transparent px-5 py-3.5 focus:outline-none text-slate-700 placeholder-slate-400 text-base"
              />
            </div>
            
            <button
              type="submit"
              disabled={!inputText.trim() || isLoading}
              className={`w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg ${
                inputText.trim() 
                  ? 'bg-emerald-600 hover:bg-emerald-700 text-white transform hover:scale-105 active:scale-90 rotate-0' 
                  : 'bg-slate-200 text-slate-400 rotate-90 cursor-not-allowed'
              }`}
            >
              <Send size={20} className={document.dir === 'rtl' ? 'rotate-180' : ''} />
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

export default PlantApp;
