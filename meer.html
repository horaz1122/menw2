import React, { useState, useRef, useEffect } from 'react';
import { Send, Leaf, Sprout, Sun, Droplets, Info, User, Bot, MapPin, Clock } from 'lucide-react';

// Ù¾ÛŽÚ©Ù‡Ø§ØªÛ•ÛŒÛ•Ú©ÛŒ Ø¨Ú†ÙˆÙˆÚ© Ø¨Û† Ù…Ø§Ù…Û•ÚµÛ•Ú©Ø±Ø¯Ù† Ø¨Û• ÙˆÛŽÙ†Û•ÛŒ Ø¨Û†ØªÛ•Ú©Û• Ø¨Û•Ø´ÛŽÙˆÛ•ÛŒÛ•Ú©ÛŒ Ø³Û•Ù„Ø§Ù…Û•Øª
// Ø¦Û•Ú¯Û•Ø± ÙˆÛŽÙ†Û•Ú©Û• Ú©ÛŽØ´Û•ÛŒ Ù‡Û•Ø¨ÙˆÙˆØŒ Ø¦Ø§ÛŒÚ©Û†Ù†ÛŽÚ© Ù†ÛŒØ´Ø§Ù† Ø¯Û•Ø¯Ø§Øª
const BotAvatar = () => {
  const [imgError, setImgError] = useState(false);

  if (imgError) {
    return <Bot size={20} className="text-emerald-700" />;
  }

  return (
    <img 
      src="mer.jpg" 
      alt="Bot" 
      className="w-full h-full object-cover" 
      onError={() => setImgError(true)} 
    />
  );
};

const PlantApp = () => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      text: "Ø³ÚµØ§Ùˆ! Ø¨Û•Ø®ÛŽØ±Ø¨ÛŽÙ† Ø¨Û† Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± ðŸŒ¿. Ù…Ù† Ù„ÛŽØ±Û•Ù… Ø¨Û† Ø¦Û•ÙˆÛ•ÛŒ Ù‡Ø§ÙˆÚ©Ø§Ø±ÛŒØª Ø¨Ú©Û•Ù… Ù„Û• Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù† Ùˆ Ú†Ø§ÙˆØ¯ÛŽØ±ÛŒÚ©Ø±Ø¯Ù†ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Ø§Ù†Øª. Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ù¾Ø±Ø³ÛŒØ§Ø±Ù… Ù„ÛŽ Ø¨Ú©Û•ÛŒØª Ø¯Û•Ø±Ø¨Ø§Ø±Û•ÛŒ Ø¬Û†Ø±Û•Ú©Ø§Ù†ØŒ Ù†Ø±Ø®ØŒ ÛŒØ§Ù† Ú†Û†Ù†ÛŒÛ•ØªÛŒ Ø¨Û•Ø®ÛŽÙˆÚ©Ø±Ø¯Ù†.",
      sender: 'bot'
    }
  ]);
  const [inputText, setInputText] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [headerImgError, setHeaderImgError] = useState(false); // Ø¨Û† Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©ÛŽØ´Û•ÛŒ ÙˆÛŽÙ†Û•ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const generateResponse = (text) => {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('Ø¦Ø§Ùˆ') || lowerText.includes('water')) {
      return "Ø¨Û† Ø¦Ø§ÙˆØ¯Ø§Ù†ØŒ Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ú•ÛŽØ³Ø§ Ø¦Û•ÙˆÛ•ÛŒÛ• Ù¾Û•Ù†Ø¬Û•Øª Ø¨Ø®Û•ÛŒØªÛ• Ù†Ø§Ùˆ Ø®Ø§Ú©Û•Ú©Û•ÙˆÛ• (Ù†Ø²ÛŒÚ©Û•ÛŒ Ù¢-Ù£ Ø³Ù…). Ø¦Û•Ú¯Û•Ø± ÙˆØ´Ú© Ø¨ÙˆÙˆØŒ Ø¦Ø§ÙˆÛŒ Ø¨Ø¯Û•. Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¦Ø§Ù…ÛŽØ±ÛŒ Ù¾ÛŽÙˆØ§Ù†ÛŒ Ø´ÛŽÛŒ Ø®Ø§Ú©Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ú©Ø§Ø±Û•Ú©Û•Øª Ø¦Ø§Ø³Ø§Ù† Ø¯Û•Ú©Ø§Øª.";
    } else if (lowerText.includes('Ø®Û†Ø±') || lowerText.includes('Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ')) {
      return "Ø²Û†Ø±Ø¨Û•ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Ø§Ù† Ø­Û•Ø²ÛŒØ§Ù† Ø¨Û• Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ù†Ø§Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ÛŒÛ•. Ø¦Û•Ú¯Û•Ø± Ø´ÙˆÛŽÙ†Û•Ú©Û•Øª ØªØ§Ø±ÛŒÚ©Û•ØŒ Ø¦ÛŽÙ…Û• Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ú•ÙˆÛ•Ú©ÛŒ ÙˆÛ•Ú© 'Ø²Ø§Ù…ÙÛ†Ù„ÛŒØ§' Ùˆ 'Ø³Ø§Ù†Ø³ÛŽÚ¤ÛŽØ±ÛŒØ§'Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ø¨Û•Ø±Ú¯Û•ÛŒ Ú©Û•Ù… Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ø¯Û•Ú¯Ø±Ù†.";
    } else if (lowerText.includes('Ø²Û•Ø±Ø¯') || lowerText.includes('Ù†Û•Ø®Û†Ø´ÛŒ')) {
      return "Ø²Û•Ø±Ø¯Ø¨ÙˆÙˆÙ†ÛŒ Ú¯Û•ÚµØ§ Ø²Û†Ø±Ø¬Ø§Ø± Ø¨Û•Ù‡Û†ÛŒ Ø²Û†Ø± Ø¦Ø§ÙˆØ¯Ø§Ù†Û•ÙˆÛ•ÛŒÛ•. Ù‡Û•Ø±ÙˆÛ•Ù‡Ø§ Ø¯Û•Ú©Ø±ÛŽØª Ø¨Û•Ù‡Û†ÛŒ Ú©Û•Ù…ÛŒ Ø¦Ø§Ø³Ù† Ø¨ÛŽØª. Ø¦ÛŽÙ…Û• Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ø¬Û†Ø±ÛŒ Ù¾Û•ÛŒÙ† Ùˆ Ø¯Û•Ø±Ù…Ø§Ù†ÛŒ Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©Û•Ú•ÙˆÙˆÙ…Ø§Ù† Ù‡Û•ÛŒÛ•ØŒ Ø¯Û•ØªÙˆØ§Ù†ÛŒØª ÙˆÛŽÙ†Û•ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Û•Øª Ø¨ÛŽÙ†ÛŒØª Ø¨Û† Ø´Û•ØªÚµÚ¯Û• ØªØ§ Ø¨Ø§Ø´ØªØ± Ù‡Ø§ÙˆÚ©Ø§Ø±ÛŒØª Ø¨Ú©Û•ÛŒÙ†.";
    } else if (lowerText.includes('Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†') || lowerText.includes('Ø´ÙˆÛŽÙ†') || lowerText.includes('location')) {
      return "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±: Ø³Û•Ø±Û•ØªØ§ÛŒ Ø´Û•Ù‚Ø§Ù…ÛŒ Ø³Û•Ø±Û•Ú©ÛŒØŒ ØªÛ•Ù†ÛŒØ´Øª Ø¨Ø§Ø®Ú†Û•ÛŒ Ú¯Ø´ØªÛŒ. Ú†Ø§ÙˆÛ•Ú•ÛŽÛŒ Ù‡Ø§ØªÙ†ØªØ§Ù†ÛŒÙ†!";
    } else if (lowerText.includes('Ù†Ø±Ø®') || lowerText.includes('price')) {
      return "Ù†Ø±Ø®Û•Ú©Ø§Ù†Ù…Ø§Ù† Ø²Û†Ø± Ú¯ÙˆÙ†Ø¬Ø§ÙˆÙ†! Ù†Ø±Ø®ÛŒ Ú¯ÙˆÚµÛ•Ú©Ø§Ù† Ø¨Û•Ù¾ÛŽÛŒ Ù‚Û•Ø¨Ø§Ø±Û• Ùˆ Ø¬Û†Ø± Ø¯Û•Ú¯Û†Ú•ÛŽØª. Ø¨Û† Ù†Ù…ÙˆÙˆÙ†Û• Ú©Ø§Ú©ØªÙˆØ³Û•Ú©Ø§Ù†Ù…Ø§Ù† Ù„Û• Ù£Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±Û•ÙˆÛ• Ø¯Û•Ø³Øª Ù¾ÛŽ Ø¯Û•Ú©Ø§Øª. Ø³Û•Ø±Ø¯Ø§Ù†Ù…Ø§Ù† Ø¨Ú©Û• Ø¨Û† Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Û†ÙÛ•Ø±Û•Ú©Ø§Ù†.";
    } else if (lowerText.includes('Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…') || lowerText.includes('Ú©Ø±Ø§ÙˆÛ•')) {
      return "Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ù‡Û•Ù…ÙˆÙˆ Ú•Û†Ú˜ÛŽÚ© Ù„Û• Ú©Ø§ØªÚ˜Ù…ÛŽØ± Ù¨ÛŒ Ø¨Û•ÛŒØ§Ù†ÛŒ ØªØ§ Ù¡Ù ÛŒ Ø´Û•Ùˆ Ú©Ø±Ø§ÙˆÛ•ÛŒÛ•.";
    } else {
      return "Ù¾Ø±Ø³ÛŒØ§Ø±ÛŽÚ©ÛŒ Ø¨Ø§Ø´Û•! ØªÚ©Ø§ÛŒÛ• Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¨Ú©Û•ÛŒØª Ø¨Û† Ú•Ø§ÙˆÛŽÚ˜ÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ØŒ ÛŒØ§Ù† Ù¾Ø±Ø³ÛŒØ§Ø±Û•Ú©Û•Øª Ú•ÙˆÙˆÙ†ØªØ± Ø¨Ú©Û•ÛŒØªÛ•ÙˆÛ•ØŸ";
    }
  };

  const handleSend = (e) => {
    e.preventDefault();
    if (!inputText.trim()) return;

    const userMessage = {
      id: messages.length + 1,
      text: inputText,
      sender: 'user'
    };

    setMessages(prev => [...prev, userMessage]);
    setInputText("");
    setIsLoading(true);

    setTimeout(() => {
      const botResponse = {
        id: messages.length + 2,
        text: generateResponse(userMessage.text),
        sender: 'bot'
      };
      setMessages(prev => [...prev, botResponse]);
      setIsLoading(false);
    }, 1500);
  };

  return (
    <div dir="rtl" className="flex flex-col h-screen bg-emerald-50 font-sans text-gray-800">
      {/* Header */}
      <header className="bg-emerald-700 text-white p-4 shadow-lg flex items-center gap-4 border-b-4 border-emerald-500">
        <div className="relative">
          <div className="w-14 h-14 rounded-full bg-white border-2 border-emerald-300 overflow-hidden shadow-sm flex items-center justify-center">
            {/* Logo Image Logic */}
            {!headerImgError ? (
              <img 
                src="mer.jpg" 
                alt="Mer Logo" 
                className="w-full h-full object-cover"
                onError={() => setHeaderImgError(true)}
              />
            ) : (
              // Fallback Icon
              <Leaf size={32} className="text-emerald-600" />
            )}
          </div>
          <span className="absolute bottom-0 right-0 w-4 h-4 bg-green-400 border-2 border-white rounded-full"></span>
        </div>
        
        <div>
          <h1 className="text-2xl font-bold tracking-wide">Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±</h1>
          <p className="text-emerald-100 text-xs mt-1 flex items-center gap-1 opacity-90">
             <MapPin size={12} /> Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ùˆ Ø¬ÙˆØ§Ù†ØªØ±ÛŒÙ† Ú•ÙˆÛ•Ú© Ø¨Û† Ù…Ø§ÚµÛ•Ú©Û•Øª
          </p>
        </div>
      </header>

      {/* Chat Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        {messages.map((msg) => (
          <div
            key={msg.id}
            className={`flex items-end gap-2 ${
              msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row'
            }`}
          >
            <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-md ${
              msg.sender === 'user' ? 'bg-emerald-800 text-white' : 'bg-white border-2 border-emerald-600 overflow-hidden'
            }`}>
              {msg.sender === 'user' ? (
                <User size={20} />
              ) : (
                <BotAvatar />
              )}
            </div>
            
            <div
              className={`max-w-[80%] p-4 rounded-2xl shadow-sm text-sm leading-7 ${
                msg.sender === 'user'
                  ? 'bg-emerald-600 text-white rounded-br-none shadow-emerald-200'
                  : 'bg-white text-gray-800 rounded-bl-none border border-emerald-100 shadow-sm'
              }`}
            >
              {msg.text}
            </div>
          </div>
        ))}
        
        {isLoading && (
          <div className="flex items-center gap-2">
            <div className="w-10 h-10 rounded-full bg-white border border-emerald-200 flex items-center justify-center">
              <Sprout size={20} className="text-emerald-600 animate-pulse" />
            </div>
            <div className="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm border border-emerald-100">
              <div className="flex gap-1">
                <span className="w-2 h-2 bg-emerald-500 rounded-full animate-bounce"></span>
                <span className="w-2 h-2 bg-emerald-500 rounded-full animate-bounce delay-75"></span>
                <span className="w-2 h-2 bg-emerald-500 rounded-full animate-bounce delay-150"></span>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="p-4 bg-white border-t border-emerald-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <form onSubmit={handleSend} className="flex gap-2">
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            placeholder="Ù¾Ø±Ø³ÛŒØ§Ø±Û•Ú©Û•Øª Ø¨Ù†ÙˆÙˆØ³Û•..."
            className="flex-1 p-4 rounded-2xl border border-emerald-200 focus:outline-none focus:border-emerald-600 focus:ring-1 focus:ring-emerald-600 bg-emerald-50/30 text-base"
          />
          <button
            type="submit"
            disabled={!inputText.trim() || isLoading}
            className="bg-emerald-700 hover:bg-emerald-800 disabled:bg-emerald-300 text-white p-4 rounded-2xl transition-all duration-200 shadow-md flex items-center justify-center transform active:scale-95"
          >
            <Send size={22} className={document.dir === 'rtl' ? 'transform rotate-180' : ''} />
          </button>
        </form>
        
        {/* Quick Tips Tags */}
        <div className="flex gap-2 mt-4 overflow-x-auto pb-2 scrollbar-hide px-1">
          <button onClick={() => setInputText("Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ØªØ§Ù† Ú©ÙˆÛŽÛŒÛ•ØŸ")} className="flex items-center gap-1 text-xs font-medium bg-emerald-50 text-emerald-800 px-4 py-2 rounded-xl border border-emerald-100 whitespace-nowrap hover:bg-emerald-100 transition">
            <MapPin size={14} /> Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†
          </button>
          <button onClick={() => setInputText("Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…ØªØ§Ù† Ú†Û†Ù†Û•ØŸ")} className="flex items-center gap-1 text-xs font-medium bg-emerald-50 text-emerald-800 px-4 py-2 rounded-xl border border-emerald-100 whitespace-nowrap hover:bg-emerald-100 transition">
            <Clock size={14} /> Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…
          </button>
          <button onClick={() => setInputText("Ù†Ø±Ø®ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Ø§Ù†")} className="flex items-center gap-1 text-xs font-medium bg-emerald-50 text-emerald-800 px-4 py-2 rounded-xl border border-emerald-100 whitespace-nowrap hover:bg-emerald-100 transition">
            <Info size={14} /> Ù†Ø±Ø®Û•Ú©Ø§Ù†
          </button>
        </div>
      </div>
    </div>
  );
};

export default PlantApp;
