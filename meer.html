import React, { useState, useRef, useEffect } from 'react';
import { Send, Leaf, Sprout, Sun, Droplets, Info, User, Bot, MapPin, Clock, Heart } from 'lucide-react';

// Ù¾ÛŽÚ©Ù‡Ø§ØªÛ•ÛŒ ÙˆÛŽÙ†Û•ÛŒ Ø¨Û†Øª
const BotAvatar = () => {
  const [imgError, setImgError] = useState(false);

  if (imgError) {
    return (
      <div className="w-full h-full bg-emerald-100 flex items-center justify-center">
        <Bot size={24} className="text-emerald-600" />
      </div>
    );
  }

  return (
    <img 
      src="mer.jpg" 
      alt="Bot" 
      className="w-full h-full object-cover" 
      onError={() => setImgError(true)} 
    />
  );
};

const PlantApp = () => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      text: "Ø³ÚµØ§Ùˆ! Ø¨Û•Ø®ÛŽØ±Ø¨ÛŽÙ† Ø¨Û† Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± ðŸŒ¿. \nÙ…Ù† Ù„ÛŽØ±Û•Ù… Ø¨Û† ÛŒØ§Ø±Ù…Û•ØªÛŒØ¯Ø§Ù†Øª. Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ù¾Ø±Ø³ÛŒØ§Ø± Ø¨Ú©Û•ÛŒØª Ø¯Û•Ø±Ø¨Ø§Ø±Û•ÛŒ:\nâ€¢ Ù†Ø±Ø®ÛŒ Ú¯ÙˆÚµÛ•Ú©Ø§Ù† ðŸ·ï¸\nâ€¢ Ú†Û†Ù†ÛŒÛ•ØªÛŒ Ø¦Ø§ÙˆØ¯Ø§Ù† ðŸ’§\nâ€¢ Ú©ÛŽØ´Û• Ùˆ Ù†Û•Ø®Û†Ø´ÛŒÛŒÛ•Ú©Ø§Ù† ðŸ‚",
      sender: 'bot',
      time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
    }
  ]);
  const [inputText, setInputText] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [headerImgError, setHeaderImgError] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const generateResponse = (text) => {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('Ø¦Ø§Ùˆ') || lowerText.includes('water')) {
      return "Ø¨Û† Ø¦Ø§ÙˆØ¯Ø§Ù†ØŒ Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ú•ÛŽØ³Ø§ Ø¦Û•ÙˆÛ•ÛŒÛ• Ù¾Û•Ù†Ø¬Û•Øª Ø¨Ø®Û•ÛŒØªÛ• Ù†Ø§Ùˆ Ø®Ø§Ú©Û•Ú©Û•ÙˆÛ• (Ù†Ø²ÛŒÚ©Û•ÛŒ Ù¢-Ù£ Ø³Ù…). Ø¦Û•Ú¯Û•Ø± ÙˆØ´Ú© Ø¨ÙˆÙˆØŒ Ø¦Ø§ÙˆÛŒ Ø¨Ø¯Û•. Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¦Ø§Ù…ÛŽØ±ÛŒ Ù¾ÛŽÙˆØ§Ù†ÛŒ Ø´ÛŽÛŒ Ø®Ø§Ú©Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ú©Ø§Ø±Û•Ú©Û•Øª Ø¦Ø§Ø³Ø§Ù† Ø¯Û•Ú©Ø§Øª.";
    } else if (lowerText.includes('Ø®Û†Ø±') || lowerText.includes('Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ')) {
      return "Ø²Û†Ø±Ø¨Û•ÛŒ Ú•ÙˆÛ•Ú©Û•Ú©Ø§Ù† Ø­Û•Ø²ÛŒØ§Ù† Ø¨Û• Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ù†Ø§Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ÛŒÛ•. Ø¦Û•Ú¯Û•Ø± Ø´ÙˆÛŽÙ†Û•Ú©Û•Øª ØªØ§Ø±ÛŒÚ©Û•ØŒ Ø¦ÛŽÙ…Û• Ù„Û• Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ú•ÙˆÛ•Ú©ÛŒ ÙˆÛ•Ú© 'Ø²Ø§Ù…ÙÛ†Ù„ÛŒØ§' Ùˆ 'Ø³Ø§Ù†Ø³ÛŽÚ¤ÛŽØ±ÛŒØ§'Ù…Ø§Ù† Ù‡Û•ÛŒÛ• Ú©Û• Ø¨Û•Ø±Ú¯Û•ÛŒ Ú©Û•Ù… Ú•ÙˆÙˆÙ†Ø§Ú©ÛŒ Ø¯Û•Ú¯Ø±Ù†.";
    } else if (lowerText.includes('Ø²Û•Ø±Ø¯') || lowerText.includes('Ù†Û•Ø®Û†Ø´ÛŒ')) {
      return "Ø²Û•Ø±Ø¯Ø¨ÙˆÙˆÙ†ÛŒ Ú¯Û•ÚµØ§ Ø²Û†Ø±Ø¬Ø§Ø± Ø¨Û•Ù‡Û†ÛŒ Ø²Û†Ø± Ø¦Ø§ÙˆØ¯Ø§Ù†Û•ÙˆÛ•ÛŒÛ• ðŸ’§. Ù‡Û•Ø±ÙˆÛ•Ù‡Ø§ Ø¯Û•Ú©Ø±ÛŽØª Ø¨Û•Ù‡Û†ÛŒ Ú©Û•Ù…ÛŒ Ø¦Ø§Ø³Ù† Ø¨ÛŽØª. Ø¦ÛŽÙ…Û• Ø¨Ø§Ø´ØªØ±ÛŒÙ† Ø¬Û†Ø±ÛŒ Ù¾Û•ÛŒÙ† Ùˆ Ø¯Û•Ø±Ù…Ø§Ù†ÛŒ Ú†Ø§Ø±Û•Ø³Û•Ø±ÛŒ Ú©Û•Ú•ÙˆÙˆÙ…Ø§Ù† Ù‡Û•ÛŒÛ•.";
    } else if (lowerText.includes('Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†') || lowerText.includes('Ø´ÙˆÛŽÙ†')) {
      return "ðŸ“ Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±: \nØ³Û•Ø±Û•ØªØ§ÛŒ Ø´Û•Ù‚Ø§Ù…ÛŒ Ø³Û•Ø±Û•Ú©ÛŒØŒ ØªÛ•Ù†ÛŒØ´Øª Ø¨Ø§Ø®Ú†Û•ÛŒ Ú¯Ø´ØªÛŒ. \nÚ†Ø§ÙˆÛ•Ú•ÛŽÛŒ Ù‡Ø§ØªÙ†ØªØ§Ù†ÛŒÙ†!";
    } else if (lowerText.includes('Ù†Ø±Ø®') || lowerText.includes('price')) {
      return "Ù†Ø±Ø®Û•Ú©Ø§Ù†Ù…Ø§Ù† Ø²Û†Ø± Ú¯ÙˆÙ†Ø¬Ø§ÙˆÙ†! ðŸ·ï¸\nâ€¢ Ú©Ø§Ú©ØªÙˆØ³: Ù£,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\nâ€¢ Ù¾Û•ØªÛ†Ø³: Ù¥,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\nâ€¢ Ù…Û•ØªØ§Øª: Ù¡Ù¥,Ù Ù Ù  Ø¯ÛŒÙ†Ø§Ø±\nØ³Û•Ø±Ø¯Ø§Ù†Ù…Ø§Ù† Ø¨Ú©Û• Ø¨Û† Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¦Û†ÙÛ•Ø±Û•Ú©Ø§Ù†.";
    } else if (lowerText.includes('Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…') || lowerText.includes('Ú©Ø±Ø§ÙˆÛ•')) {
      return "ðŸ•’ Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…:\nÙ‡Û•Ù…ÙˆÙˆ Ú•Û†Ú˜ÛŽÚ© Ù„Û• Ú©Ø§ØªÚ˜Ù…ÛŽØ± Ù¨ÛŒ Ø¨Û•ÛŒØ§Ù†ÛŒ ØªØ§ Ù¡Ù ÛŒ Ø´Û•Ùˆ Ú©Ø±Ø§ÙˆÛ•ÛŒÛ•.";
    } else {
      return "Ù¾Ø±Ø³ÛŒØ§Ø±ÛŽÚ©ÛŒ Ø¨Ø§Ø´Û•! ðŸ¤” ØªÚ©Ø§ÛŒÛ• Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø³Û•Ø±Ø¯Ø§Ù†ÛŒ Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ± Ø¨Ú©Û•ÛŒØª Ø¨Û† Ú•Ø§ÙˆÛŽÚ˜ÛŒ Ú•Ø§Ø³ØªÛ•ÙˆØ®Û†ØŒ ÛŒØ§Ù† Ù¾Ø±Ø³ÛŒØ§Ø±Û•Ú©Û•Øª Ú•ÙˆÙˆÙ†ØªØ± Ø¨Ú©Û•ÛŒØªÛ•ÙˆÛ•ØŸ";
    }
  };

  const handleSend = (e) => {
    e.preventDefault();
    if (!inputText.trim()) return;

    const userMessage = {
      id: messages.length + 1,
      text: inputText,
      sender: 'user',
      time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
    };

    setMessages(prev => [...prev, userMessage]);
    setInputText("");
    setIsLoading(true);

    setTimeout(() => {
      const botResponse = {
        id: messages.length + 2,
        text: generateResponse(userMessage.text),
        sender: 'bot',
        time: new Date().toLocaleTimeString('ckb-IQ', { hour: '2-digit', minute: '2-digit' })
      };
      setMessages(prev => [...prev, botResponse]);
      setIsLoading(false);
    }, 1500);
  };

  return (
    // Background wrapper
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-0 sm:p-4 font-sans text-slate-800" dir="rtl">
      
      {/* Main App Container - Mobile sized on desktop */}
      <div className="w-full max-w-md bg-white sm:rounded-[30px] shadow-2xl overflow-hidden h-[100dvh] sm:h-[85vh] flex flex-col relative border-4 border-white/50 ring-1 ring-black/5">
        
        {/* Header with Gradient */}
        <header className="bg-gradient-to-r from-emerald-600 via-emerald-500 to-teal-500 text-white p-4 pt-6 pb-6 shadow-lg z-10 relative overflow-hidden">
          {/* Decorative circles */}
          <div className="absolute top-0 left-0 w-32 h-32 bg-white/10 rounded-full -translate-x-10 -translate-y-10 blur-xl"></div>
          <div className="absolute bottom-0 right-0 w-24 h-24 bg-teal-900/10 rounded-full translate-x-8 translate-y-8 blur-lg"></div>

          <div className="relative flex items-center gap-4">
            <div className="relative group cursor-pointer">
              <div className="w-14 h-14 rounded-full bg-white p-1 shadow-md transition-transform transform group-hover:scale-105">
                <div className="w-full h-full rounded-full overflow-hidden relative">
                  {!headerImgError ? (
                    <img 
                      src="mer.jpg" 
                      alt="Mer Logo" 
                      className="w-full h-full object-cover"
                      onError={() => setHeaderImgError(true)}
                    />
                  ) : (
                    <div className="w-full h-full bg-emerald-50 flex items-center justify-center">
                       <Leaf size={24} className="text-emerald-500" />
                    </div>
                  )}
                </div>
              </div>
              <div className="absolute bottom-0 right-0 w-4 h-4 bg-green-400 border-2 border-emerald-600 rounded-full"></div>
            </div>
            
            <div className="flex-1">
              <h1 className="text-xl font-bold flex items-center gap-2">
                Ø´Û•ØªÚµÚ¯Û•ÛŒ Ù…ÛŒØ±
                <Heart size={16} className="text-pink-300 fill-pink-300 animate-pulse" />
              </h1>
              <div className="flex items-center gap-2 text-emerald-50 text-xs font-medium mt-1">
                <span className="flex items-center gap-1 bg-white/20 px-2 py-0.5 rounded-full backdrop-blur-sm">
                  <span className="w-1.5 h-1.5 rounded-full bg-green-300 animate-pulse"></span>
                  Ø¦Û†Ù†ÚµØ§ÛŒÙ†
                </span>
                <span className="opacity-90">ÙˆÛ•ÚµØ§Ù…Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ø®ÛŽØ±Ø§</span>
              </div>
            </div>
          </div>
        </header>

        {/* Chat Area */}
        <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 relative scroll-smooth">
          {/* Subtle Background Pattern */}
          <div className="absolute inset-0 opacity-5 pointer-events-none" 
               style={{backgroundImage: 'radial-gradient(#059669 1px, transparent 1px)', backgroundSize: '20px 20px'}}>
          </div>

          {messages.map((msg, index) => (
            <div
              key={msg.id}
              className={`flex items-end gap-3 group animate-in slide-in-from-bottom-2 duration-500 fade-in ${
                msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row'
              }`}
            >
              {/* Avatar */}
              <div className={`w-9 h-9 rounded-full flex items-center justify-center shrink-0 shadow-sm transition-transform hover:scale-110 ${
                msg.sender === 'user' 
                  ? 'bg-gradient-to-br from-emerald-600 to-teal-700 text-white' 
                  : 'bg-white border border-gray-100 overflow-hidden'
              }`}>
                {msg.sender === 'user' ? <User size={18} /> : <BotAvatar />}
              </div>
              
              {/* Message Bubble */}
              <div className={`max-w-[75%] relative shadow-md ${
                  msg.sender === 'user' ? 'text-white' : 'text-gray-700'
                }`}
              >
                <div
                  className={`p-3.5 text-sm leading-relaxed whitespace-pre-line ${
                    msg.sender === 'user'
                      ? 'bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl rounded-br-none'
                      : 'bg-white rounded-2xl rounded-bl-none border border-gray-100'
                  }`}
                >
                  {msg.text}
                </div>
                {/* Time Stamp */}
                <span className={`text-[10px] absolute -bottom-5 w-20 opacity-0 group-hover:opacity-60 transition-opacity ${
                  msg.sender === 'user' ? 'left-0 text-left' : 'right-0 text-right'
                }`}>
                  {msg.time}
                </span>
              </div>
            </div>
          ))}
          
          {isLoading && (
            <div className="flex items-center gap-3 animate-in fade-in duration-300">
              <div className="w-9 h-9 rounded-full bg-white border border-gray-100 flex items-center justify-center shadow-sm">
                <Bot size={18} className="text-emerald-600" />
              </div>
              <div className="bg-white px-4 py-3 rounded-2xl rounded-bl-none shadow-sm border border-gray-100">
                <div className="flex gap-1.5">
                  <span className="w-2 h-2 bg-emerald-400 rounded-full animate-bounce"></span>
                  <span className="w-2 h-2 bg-emerald-400 rounded-full animate-bounce delay-100"></span>
                  <span className="w-2 h-2 bg-emerald-400 rounded-full animate-bounce delay-200"></span>
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} className="h-2" />
        </div>

        {/* Footer / Input Area */}
        <div className="bg-white p-3 sm:p-4 border-t border-gray-100 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-10">
          
          {/* Quick Actions (Scrollable) */}
          <div className="flex gap-2 mb-3 overflow-x-auto pb-2 scrollbar-none mask-fade-sides">
             <button onClick={() => setInputText("Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ØŸ")} className="flex items-center gap-1.5 text-xs font-semibold bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-3 py-2 rounded-xl transition-colors border border-emerald-100 shrink-0">
               <MapPin size={14} /> Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†
             </button>
             <button onClick={() => setInputText("Ù†Ø±Ø®ÛŒ Ú¯ÙˆÚµÛ•Ú©Ø§Ù†")} className="flex items-center gap-1.5 text-xs font-semibold bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded-xl transition-colors border border-blue-100 shrink-0">
               <Info size={14} /> Ù†Ø±Ø®Û•Ú©Ø§Ù†
             </button>
             <button onClick={() => setInputText("Ú†Û†Ù† Ø¦Ø§ÙˆÛŒ Ø¨Ø¯Û•Ù…ØŸ")} className="flex items-center gap-1.5 text-xs font-semibold bg-orange-50 hover:bg-orange-100 text-orange-700 px-3 py-2 rounded-xl transition-colors border border-orange-100 shrink-0">
               <Droplets size={14} /> Ø¦Ø§ÙˆØ¯Ø§Ù†
             </button>
             <button onClick={() => setInputText("Ú©Ø§ØªÛŒ Ø¯Û•ÙˆØ§Ù…")} className="flex items-center gap-1.5 text-xs font-semibold bg-purple-50 hover:bg-purple-100 text-purple-700 px-3 py-2 rounded-xl transition-colors border border-purple-100 shrink-0">
               <Clock size={14} /> Ú©Ø§Øª
             </button>
          </div>

          {/* Input Form */}
          <form onSubmit={handleSend} className="flex gap-2 items-center bg-gray-50 p-1.5 rounded-[20px] border border-gray-200 focus-within:border-emerald-400 focus-within:ring-2 focus-within:ring-emerald-100 transition-all shadow-inner">
            <input
              type="text"
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              placeholder="Ù†ÙˆØ³ÛŒÙ†..."
              className="flex-1 bg-transparent px-4 py-3 focus:outline-none text-gray-700 placeholder-gray-400 font-medium"
            />
            <button
              type="submit"
              disabled={!inputText.trim() || isLoading}
              className={`p-3 rounded-2xl transition-all duration-300 flex items-center justify-center shadow-md ${
                inputText.trim() 
                  ? 'bg-gradient-to-tr from-emerald-600 to-teal-500 text-white transform hover:scale-105 active:scale-95' 
                  : 'bg-gray-200 text-gray-400 cursor-not-allowed'
              }`}
            >
              <Send size={20} className={document.dir === 'rtl' ? 'rotate-180' : ''} />
            </button>
          </form>
          
          <div className="text-center mt-2">
            <p className="text-[10px] text-gray-400">Powered by Mir Garden AI</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PlantApp;
