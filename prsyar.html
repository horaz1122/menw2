<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دروستکەری پرسیار - ڕێکخستنی پێشکەوتوو</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nrt+Reg&family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHxuOA6uuX1EZGse5_JOHc3WMjvPywLD4",
            authDomain: "prsyar-c93dd.firebaseapp.com",
            projectId: "prsyar-c93dd",
            storageBucket: "prsyar-c93dd.firebasestorage.app",
            messagingSenderId: "623772510800",
            appId: "1:623772510800:web:cc49fc9bbd9ed9c170ff55",
            measurementId: "G-7KLKMNVFHC"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = 'exam-system-v1';

            window.firebaseApp = { auth, db, appId, doc, getDoc, setDoc, updateDoc, collection };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    document.getElementById('cloud-status').innerHTML = '<span class="text-green-500 text-xs"><i class="fa-solid fa-cloud"></i> پەیوەستە</span>';
                } else {
                    signInAnonymously(auth);
                }
            });

        } catch (e) {
            console.error("Firebase Init Error", e);
        }
    </script>
    
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'Arial', 'sans-serif'], nrt: ['Nrt Reg', 'Arial', 'sans-serif'] },
                    screens: { 'print': {'raw': 'print'} }
                }
            }
        }
    </script>

    <style>
        /* MAIN SCROLL FIXES */
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: #f3f4f6;
        }

        .main-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-area {
            flex: 1;
            overflow: hidden;
            display: flex;
            position: relative;
        }

        /* SCROLLABLE PANELS */
        #editor-panel, #preview-panel {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%;
            padding-bottom: 120px; 
        }

        /* A4 Paper Styles */
        .a4-paper { 
            width: 210mm; min-height: 297mm; background: white; margin: 0 auto; padding: 10mm 10mm; 
            position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            font-family: 'Nrt Reg', 'Vazirmatn', sans-serif; color: black; box-sizing: border-box; 
            transform-origin: top center; transition: transform 0.3s ease-out;
            overflow: hidden; 
        }
        
        .exam-header { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 5px; border-bottom: 2px double #000; padding-bottom: 5px; margin-bottom: 10px; align-items: center; position: relative; z-index: 10; }
        .header-section { display: flex; flex-direction: column; gap: 2px; font-size: 12px; font-weight: bold; line-height: 1.2; }
        .header-center { text-align: center; align-items: center; display: flex; flex-direction: column; justify-content: center; }
        .header-left { text-align: left; align-items: flex-end; }
        .header-logo { width: 80px; height: 80px; object-fit: contain; margin-bottom: 5px; }
        .group-badge { width: 30px; height: 30px; border: 2px solid black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1rem; margin-top: 2px; }
        
        .q-number { background: #000; color: white; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 6px; flex-shrink: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .q-sub-number { background: #fff; color: black; border: 1.5px solid black; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 6px; margin-right: 15px; font-weight: bold; flex-shrink: 0; }
        .q-score { font-size: 10px; border: 1px solid #000; padding: 1px 4px; border-radius: 4px; margin-right: auto; white-space: nowrap; }
        .section-title { width: 100%; text-align: center; font-weight: 900; font-size: 1rem; margin: 0.5rem 0 0.5rem 0; padding: 2px; border-top: 2px solid #000; border-bottom: 2px solid #000; background-color: #f3f4f6; -webkit-print-color-adjust: exact; print-color-adjust: exact; break-after: avoid; }
        .q-image { max-width: 100%; max-height: 150px; display: block; margin: 5px auto; border: 1px dashed #ccc; padding: 2px; }
        
        .q-content b { font-weight: 900; color: #000; }
        .q-content i { font-style: italic; }
        .q-content u { text-decoration: underline; }

        .two-columns { column-count: 2; column-gap: 10mm; column-rule: 1px solid #eee; }
        .break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }

        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.05); z-index: 0; pointer-events: none;
            white-space: nowrap; text-transform: uppercase; user-select: none;
        }

        input, textarea, select { font-size: 14px !important; touch-action: manipulation; }
        
        /* Math Toolbar Scroll */
        .math-toolbar { 
            display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 5px; 
            margin-bottom: 0.5rem; background: #f8fafc; padding: 8px; 
            border-radius: 6px; border: 1px solid #e2e8f0; 
            -webkit-overflow-scrolling: touch;
        }
        .math-toolbar::-webkit-scrollbar { height: 0px; display: none; }
        
        .math-btn, .format-btn { background: white; border: 1px solid #cbd5e1; color: #1e293b; padding: 6px 10px; border-radius: 4px; font-size: 14px; font-family: 'Times New Roman', serif; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; justify-content: center; min-width: 36px; cursor: pointer; flex-shrink: 0; }
        .math-btn:hover, .format-btn:hover { background: #e0f2fe; border-color: #3b82f6; }
        .format-toolbar { display: flex; gap: 5px; margin-bottom: 5px; }
        
        .mode-switch { display: flex; background: #e5e7eb; border-radius: 8px; padding: 3px; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 6px; text-align: center; border-radius: 6px; font-weight: bold; font-size: 13px; transition: all 0.2s; }
        .mode-btn.active { background: white; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .mode-btn.inactive { color: #6b7280; }

        @media print { 
            @page { size: A4; margin: 0; } 
            body { background: white; height: auto; overflow: visible; display: block; } 
            .no-print { display: none !important; } 
            .a4-paper { width: 100%; box-shadow: none; margin: 0; padding: 10mm; min-height: auto; transform: none !important; overflow: visible; } 
            #preview-panel { overflow: visible !important; height: auto !important; display: block !important; padding: 0 !important; } 
            #editor-panel, #login-overlay, #mobile-add-btn, #mobile-add-modal, #video-modal { display: none !important; } 
        }
        
        @media (max-width: 1024px) { 
            .a4-paper { transform: scale(0.65); transform-origin: top center; margin-bottom: 50px; }
            #editor-panel, #preview-panel { width: 100%; }
        }
    </style>
</head>
<body class="font-sans text-slate-800 main-layout">

    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm text-center m-4 relative">
            <div id="auth-loading" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-10 hidden rounded-2xl">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                <p class="text-xs text-gray-500">پەیوەندی دەگرێت...</p>
            </div>
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-800">سیستەمی دانانی پرسیار (Pro)</h2>
                <div class="w-16 h-1 bg-blue-500 mx-auto mt-2 rounded"></div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-5 text-right">
                <p class="text-sm text-gray-700 mb-2 font-medium leading-relaxed">
                    <i class="fa-solid fa-circle-info text-blue-500 ml-1"></i>
                    تکایە کۆدی چالاککردن داخڵ بکە:
                </p>
                <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-blue-100 shadow-sm mb-3">
                    <span class="font-mono text-xl font-bold text-blue-900 tracking-widest" dir="ltr">07501784002</span>
                </div>
            </div>
            <div class="border-t pt-4">
                <label class="block text-right text-xs font-bold text-gray-500 mb-1 mr-1">کۆدی چالاککردن:</label>
                <div class="relative mb-3">
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="password-input" class="w-full p-3 border-2 border-gray-300 rounded-xl text-center text-xl tracking-widest font-bold focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition uppercase" placeholder="کۆد لێرە بنووسە" onkeypress="if(event.key==='Enter') checkPassword()">
                </div>
                <p id="login-error" class="text-red-600 bg-red-50 text-xs mb-3 hidden p-2 rounded border border-red-200 font-bold"></p>
                <button onclick="checkPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-unlock"></i> چوونەژوورەوە
                </button>
            </div>
        </div>
    </div>

    <div id="pdf-loading" class="fixed inset-0 bg-black bg-opacity-70 z-[200] hidden flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
        <p id="loading-text">خەریکی کارکردن...</p>
    </div>

    <div id="video-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-black w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden relative">
            <button onclick="closeVideoModal()" class="absolute top-2 right-2 text-white bg-gray-700 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center z-10 transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="aspect-w-16 aspect-h-9 relative" style="padding-bottom: 56.25%; height: 0;">
                <iframe id="tutorial-video-frame" class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/E0zfhjnbyvU" title="Tutorial" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div class="content-area lg:flex-row">
        
        <div id="editor-panel" class="w-full lg:w-1/3 bg-white border-l p-4 z-10 block">
            
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                <div class="flex items-center gap-2">
                    <h2 class="text-xl font-bold text-blue-700">کۆنترۆڵ</h2>
                    <div id="cloud-status" class="text-gray-400 text-xs">...</div>
                </div>
                
                <div class="flex flex-wrap gap-1">
                     <button onclick="openVideoModal()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs"><i class="fa-brands fa-youtube"></i></button>
                     <button onclick="saveExamToCloud()" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" title="هەڵگرتن"><i class="fa-solid fa-cloud-arrow-up"></i></button>
                     <button onclick="loadExamFromCloud()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs" title="هێنانەوە"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                     <button onclick="downloadWord()" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs" title="Word"><i class="fa-solid fa-file-word"></i></button>
                     <button onclick="downloadDirectPDF()" class="bg-green-600 text-white px-2 py-1 rounded text-xs" title="PDF">PDF</button>
                     <button onclick="shuffleMCQAndAnswers()" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs" title="تێکەڵکردنی وەڵامەکان"><i class="fa-solid fa-shuffle"></i></button>
                     <button onclick="generateAnswerKey()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs" title="وەڵامنامە"><i class="fa-solid fa-key"></i></button>
                </div>
            </div>

            <div class="mode-switch">
                <button onclick="switchMode('question', 'desktop')" id="desk-mode-q" class="mode-btn active">پرسیار</button>
                <button onclick="switchMode('settings', 'desktop')" id="desk-mode-s" class="mode-btn inactive">ڕێکخستن</button>
            </div>

            <div id="desk-input-question">
                <div class="format-toolbar">
                    <button class="format-btn font-bold" onclick="insertTag('q_text', 'b')">B</button>
                    <button class="format-btn italic" onclick="insertTag('q_text', 'i')">I</button>
                    <button class="format-btn underline" onclick="insertTag('q_text', 'u')">U</button>
                </div>
                
                <div id="math-toolbar-container" class="math-toolbar"></div>

                <textarea id="q_text" rows="3" class="w-full p-2 border rounded mb-2 text-left font-sans" dir="ltr" placeholder="دەقی پرسیار..."></textarea>
                
                <div class="mb-2 bg-white p-2 rounded border border-gray-200 flex gap-2 items-center">
                    <label class="block text-xs font-bold text-gray-600"><i class="fa-regular fa-image"></i> وێنە:</label>
                    <input type="file" id="q_image" accept="image/*" class="block w-full text-xs text-gray-500">
                </div>
                
                <div class="flex gap-2 mb-2">
                    <div class="flex items-center gap-2 bg-orange-50 p-2 rounded border border-orange-100 flex-1">
                        <input type="checkbox" id="q_is_sub" class="w-4 h-4 accent-orange-600" onchange="toggleSubOptions('desktop')">
                        <label for="q_is_sub" class="text-xs font-bold text-orange-800">لقی پرسیار</label>
                        <select id="q_sub_style" class="text-xs p-1 border rounded hidden">
                            <option value="alpha">A, B, C</option>
                            <option value="number">1, 2, 3</option>
                        </select>
                    </div>
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 flex-1">
                        <input type="range" id="q_spacing" min="0" max="100" value="0" class="w-full" oninput="document.getElementById('desk-spacing-val').innerText = this.value + 'mm'">
                        <div class="text-xs text-center text-gray-500 mt-1">بۆشایی: <span id="desk-spacing-val">0mm</span></div>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-2">
                    <input type="number" id="q_score" value="2" class="w-20 p-2 border rounded text-center" placeholder="نمرە">
                    <select id="q_type" class="flex-1 p-2 border rounded" onchange="toggleMCQ(this.value, 'desktop')">
                        <option value="mcq">هەڵبژاردن</option>
                        <option value="text">نووسین</option>
                        <option value="tf">ڕاست و هەڵە</option>
                        <option value="fill">بۆشایی</option>
                    </select>
                </div>

                <div id="mcq_options_container" class="hidden bg-white p-2 border rounded mb-2">
                    <textarea id="q_mcq_opts" rows="3" class="w-full p-2 border text-sm text-left font-sans mb-2" dir="ltr" placeholder="A) هەڵبژاردەکان لێرە بنووسە..."></textarea>
                </div>
                
                <div class="bg-green-50 p-2 border border-green-200 rounded mb-2">
                    <label class="block text-xs font-bold text-green-800 mb-1">وەڵامی ڕاست (بۆ وەڵامنامە):</label>
                    <input type="text" id="q_answer" class="w-full p-1 border rounded text-sm" placeholder="وەڵامەکە بنووسە یان پیتی هەڵبژاردن">
                </div>

                <button onclick="addItemDesktop()" id="desk-add-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded text-sm shadow mt-2 hover:bg-blue-700 transition">زیادکردن</button>
            </div>

            <div id="desk-input-settings" class="hidden p-2 space-y-4">
                
                <div class="bg-white p-4 rounded border border-blue-200 shadow-sm">
                    <h3 class="font-bold text-sm mb-3 text-blue-700 border-b pb-2">زانیاری سەرپەڕە (Header)</h3>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-600 mb-1">لۆگۆ:</label>
                        <input type="file" id="h_logo_input" accept="image/*" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700">
                    </div>

                    <div class="grid grid-cols-1 gap-2 mb-2">
                        <input type="text" id="h_school" placeholder="ناوی قوتابخانە" class="w-full p-2 border rounded text-sm" oninput="updatePaper()">
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="h_subject" placeholder="بابەت" class="p-2 border rounded text-sm" oninput="updatePaper()">
                        <input type="text" id="h_class" placeholder="پۆل" class="p-2 border rounded text-sm" oninput="updatePaper()">
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="h_date" placeholder="بەروار" class="p-2 border rounded text-sm" oninput="updatePaper()">
                        <input type="text" id="h_time" placeholder="کات" value="٢ کاتژمێر" class="p-2 border rounded text-sm" oninput="updatePaper()">
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="h_type" value="خولی یەکەم" class="p-2 border rounded text-sm" oninput="updatePaper()">
                        <input type="text" id="h_year" value="٢٠٢٤ - ٢٠٢٥" class="p-2 border rounded text-sm" oninput="updatePaper()">
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="h_dir" value="ب. پەروەردە" class="p-2 border rounded text-sm" oninput="updatePaper()">
                        <input type="text" id="h_gov" value="حکومەتی هەرێم" class="p-2 border rounded text-sm" oninput="updatePaper()">
                    </div>
                    
                    <div class="mt-2">
                        <input type="text" id="h_group" placeholder="گرووپ (A, B)" class="w-full p-2 border rounded text-sm text-center font-bold" oninput="updatePaper()">
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded border">
                    <h3 class="font-bold text-sm mb-2 text-gray-700">ڕێکخستنی لاپەڕە</h3>
                    <label class="block text-xs font-bold mb-1">قەبارەی فۆنت:</label>
                    <input type="range" min="10" max="24" value="16" class="w-full mb-3" oninput="changeFontSize(this.value)">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="toggle-columns" class="w-5 h-5 accent-blue-600" onchange="toggleColumns(this.checked)">
                        <label for="toggle-columns" class="font-bold text-sm">دوو ستوون (Two Columns)</label>
                    </div>
                    <hr class="border-gray-300 my-3">
                    <label class="block text-xs font-bold mb-1">واتەرمارک (Watermark):</label>
                    <input type="text" id="watermark-text" class="w-full p-2 border rounded" placeholder="ناوی خۆت..." oninput="updateWatermark(this.value)">
                </div>
                
                <div class="bg-gray-100 p-4 rounded border">
                    <h3 class="font-bold text-sm mb-2 text-gray-700">زیادکردنی سەردێڕ</h3>
                    <input type="text" id="t_text" class="w-full p-2 border-2 border-gray-400 rounded font-bold text-center mb-2" placeholder="نموونە: پرسیاری دووەم">
                    <button onclick="addTitleItem()" class="w-full bg-gray-600 text-white py-2 rounded text-sm">زیادکردنی سەردێڕ</button>
                </div>
            </div>

            <div id="questions_list_container" class="mt-4 border-t pt-2 pb-20">
                 <div class="flex justify-between border-b pb-1 mb-2 bg-white z-10">
                    <h3 class="text-sm font-bold text-gray-500">لیستی پرسیارەکان</h3>
                    <button onclick="clearAll()" class="text-red-500 text-xs hover:bg-red-50 px-2 rounded">سڕینەوەی هەموو</button>
                </div>
                <div id="questions_mini_list" class="space-y-2 text-sm"></div>
            </div>
        </div>
        
        <div id="preview-panel" class="w-full lg:w-2/3 bg-gray-200 hidden lg:block">
            <div id="paper-container" class="flex justify-center items-start w-full min-h-full">
                <div id="examPaper" class="a4-paper">
                    <div id="paper-watermark" class="watermark"></div>
                    <div class="exam-header">
                        <div class="header-section text-right">
                            <div id="view_gov">حکومەتی هەرێمی کوردستان</div>
                            <div id="view_min">وەزارەتی پەروەردە</div>
                            <div id="view_dir">بەڕێوەبەرایەتی پەروەردە</div>
                            <div id="view_school" class="mt-1 font-black text-sm">...</div>
                        </div>
                        <div class="header-section header-center">
                            <img id="header_logo_img" src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Kurdistan_Regional_Government_emblem.svg" class="header-logo" alt="Logo">
                            <div class="border-b-2 border-black pb-1 mb-1 font-black text-lg">پرسیارەکانی <span id="view_subject">...</span></div>
                            <div><span id="view_type">...</span> - <span id="view_year">...</span></div>
                        </div>
                        <div class="header-section header-left">
                            <div>بابەت: <span id="view_subject_2">...</span></div>
                            <div>پۆل: <span id="view_class">...</span></div>
                            <div>کات: <span id="view_time">...</span></div>
                            <div>بەروار: <span id="view_date">...</span></div>
                            <div id="group_container" class="hidden">
                                <div class="group-badge" id="view_group">A</div>
                            </div>
                        </div>
                    </div>
                    <div id="paper_questions" class="space-y-2 text-base">
                        <div class="text-center text-gray-400 py-10 no-print">پرسیارەکان لێرە دەردەکەون...</div>
                    </div>
                    <div class="mt-10 pt-2 flex justify-between items-end break-inside-avoid">
                        <div class="text-center w-24"><p class="font-bold text-xs mb-4">مامۆستا</p><div class="border-b border-black"></div></div>
                        <div class="text-center"><p class="font-bold italic text-xs">هیوای سەرکەوتن</p></div>
                        <div class="text-center w-24"><p class="font-bold text-xs mb-4">بەڕێوەبەر</p><div class="border-b border-black"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="no-print lg:hidden fixed bottom-0 left-0 w-full bg-white border-t flex z-30 shadow-lg pb-safe">
        <button onclick="switchTab('editor')" id="btn-editor" class="flex-1 py-4 text-center font-bold text-blue-600 border-t-2 border-blue-600 bg-blue-50">نووسین</button>
        <button onclick="switchTab('preview')" id="btn-preview" class="flex-1 py-4 text-center font-bold text-gray-500">بینین</button>
    </div>

    <script>
        // --- SECURE DEVICE LOGIC ---
        let currentDeviceId = localStorage.getItem('app_device_id');
        if (!currentDeviceId) { currentDeviceId = crypto.randomUUID(); localStorage.setItem('app_device_id', currentDeviceId); }

        // --- AUTH ---
        async function checkPassword() {
            const inputCode = document.getElementById('password-input').value.trim();
            const errorMsg = document.getElementById('login-error');
            const loading = document.getElementById('auth-loading');
            errorMsg.classList.add('hidden');

            if (inputCode === '23819933') {
                localStorage.setItem('exam_app_code', inputCode);
                document.getElementById('login-overlay').style.display = 'none';
                loadData();
                return;
            }

            if (!inputCode || inputCode.length < 6) { errorMsg.innerText = "کۆدەکە هەڵەیە!"; errorMsg.classList.remove('hidden'); return; }
            loading.classList.remove('hidden');
            
            const { db, doc, getDoc, setDoc, collection, appId } = window.firebaseApp;
            const codeRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'access_codes'), String(inputCode));

            try {
                const docSnap = await getDoc(codeRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.deviceId === currentDeviceId || !data.deviceId) { 
                         if(!data.deviceId) await setDoc(codeRef, { deviceId: currentDeviceId, usedAt: new Date().toISOString() }, { merge: true });
                         localStorage.setItem('exam_app_code', inputCode); 
                         document.getElementById('login-overlay').style.display='none'; 
                         loadData(); 
                    } else { 
                        errorMsg.innerText = "ئەم کۆدە لەسەر ئامێرێکی تر بەکارهاتووە."; errorMsg.classList.remove('hidden'); 
                    }
                } else {
                      errorMsg.innerText = "ئەم کۆدە بوونی نییە."; errorMsg.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Firebase Error:", err);
                errorMsg.innerText = "کێشەی ئینتەرنێت هەیە."; errorMsg.classList.remove('hidden');
            } finally { loading.classList.add('hidden'); }
        }

        // --- APP STATE ---
        let examData = [];
        let currentMode = 'question';
        let editIndex = -1;
        let layoutSettings = { fontSize: 16, twoColumns: false, watermark: '' };

        function loadData() {
            const saved = localStorage.getItem('examData');
            if (saved) examData = JSON.parse(saved);
            
            const savedLayout = localStorage.getItem('layoutSettings');
            if(savedLayout) {
                layoutSettings = JSON.parse(savedLayout);
                applyLayoutSettings();
            }
            
            // Header Data Load
            ['school','subject','class','time','date','dir','gov','type','year','group'].forEach(f => {
                const val = localStorage.getItem('h_'+f);
                if(val && document.getElementById('h_'+f)) document.getElementById('h_'+f).value = val;
            });
            const logo = localStorage.getItem('header_logo');
            if(logo) document.getElementById('header_logo_img').src = logo;

            renderQuestions();
            updatePaper(); 
        }

        function saveData() {
            localStorage.setItem('examData', JSON.stringify(examData));
            localStorage.setItem('layoutSettings', JSON.stringify(layoutSettings));
            renderQuestions();
        }

        // --- MATH BUTTONS GENERATOR ---
        const allMathSymbols = [
            {l:'$+$', c:'+'}, {l:'$-$', c:'-'}, {l:'$\\times$', c:'\\times'}, {l:'$\\div$', c:'\\div'},
            {l:'$\\pm$', c:'\\pm'}, {l:'$=$', c:'='}, {l:'$\\neq$', c:'\\neq'}, {l:'$\\approx$', c:'\\approx'},
            {l:'$<\\!$', c:'<'}, {l:'$>\\!$', c:'>'}, {l:'$\\leq$', c:'\\le'}, {l:'$\\geq$', c:'\\ge'},
            {l:'$\\sqrt{x}$', c:'sqrt'}, {l:'$\\frac{a}{b}$', c:'frac'}, {l:'$x^2$', c:'pow'}, {l:'$x_2$', c:'sub'},
            {l:'$e^x$', c:'exp'}, {l:'$\\infty$', c:'\\infty'}, {l:'$\\log$', c:'\\log'}, {l:'$\\ln$', c:'\\ln'},
            {l:'$\\in$', c:'\\in'}, {l:'$\\notin$', c:'\\notin'}, {l:'$\\cup$', c:'\\cup'}, {l:'$\\cap$', c:'\\cap'},
            {l:'$\\subset$', c:'\\subset'}, {l:'$\\subseteq$', c:'\\subseteq'}, {l:'$\\forall$', c:'\\forall'}, {l:'$\\exists$', c:'\\exists'},
            {l:'$\\emptyset$', c:'\\emptyset'}, {l:'$\\mathbb{R}$', c:'\\mathbb{R}'}, {l:'$\\mathbb{Z}$', c:'\\mathbb{Z}'},
            {l:'$\\triangle$', c:'\\triangle'}, {l:'$\\angle$', c:'\\angle'}, {l:'$\\perp$', c:'\\perp'}, {l:'$\\parallel$', c:'\\parallel'},
            {l:'$\\pi$', c:'\\pi'}, {l:'$\\circ$', c:'^\\circ'}, {l:'$\\sin$', c:'\\sin'}, {l:'$\\cos$', c:'\\cos'}, 
            {l:'$\\tan$', c:'\\tan'}, {l:'$\\theta$', c:'\\theta'},
            {l:'$\\int$', c:'int'}, {l:'$\\sum$', c:'sum'}, {l:'$\\lim$', c:'lim'}, {l:'$\\partial$', c:'\\partial'},
            {l:'$\\alpha$', c:'\\alpha'}, {l:'$\\beta$', c:'\\beta'}, {l:'$\\Delta$', c:'\\Delta'}, {l:'$\\lambda$', c:'\\lambda'},
            {l:'$\\rightarrow$', c:'\\rightarrow'}, {l:'$\\Rightarrow$', c:'\\Rightarrow'}
        ];

        function initMathButtons(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            allMathSymbols.forEach(btn => {
                const b = document.createElement('button');
                b.className = 'math-btn';
                b.innerHTML = btn.l;
                b.onclick = (e) => { e.preventDefault(); insertMath('q_text', btn.c); };
                container.appendChild(b);
            });
        }

        function insertMath(inputId, code) {
            const input = document.getElementById(inputId);
            let text = code;
            if (code === 'sqrt') text = '$\\sqrt{}$';
            else if (code === 'frac') text = '$\\frac{}{}$';
            else if (code === 'pow') text = '$^{}$';
            else if (code === 'sub') text = '$_{}$';
            else if (code === 'exp') text = '$e^{}$';
            else if (code === 'int') text = '$\\int_{}^{}$';
            else if (code === 'sum') text = '$\\sum_{}^{}$';
            else if (code === 'lim') text = '$\\lim_{ \\to }$';
            else if (!code.startsWith('$')) text = '$' + code + '$'; 
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const val = input.value;
            input.value = val.substring(0, start) + text + val.substring(end);
            input.focus();
            
            if(text.includes('{}')) {
                input.selectionStart = input.selectionEnd = start + text.indexOf('{') + 1;
            } else {
                input.selectionStart = input.selectionEnd = start + text.length; 
            }
        }

        initMathButtons('math-toolbar-container');

        // --- RICH TEXT ---
        function insertTag(inputId, tag) {
            const input = document.getElementById(inputId);
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            const selected = text.substring(start, end);
            const replacement = `<${tag}>${selected}</${tag}>`;
            input.value = text.substring(0, start) + replacement + text.substring(end);
            input.focus();
        }

        // --- LAYOUT FUNCTIONS ---
        function changeFontSize(val) {
            layoutSettings.fontSize = val;
            document.getElementById('paper_questions').style.fontSize = val + 'px';
            saveData();
        }

        function toggleColumns(checked) {
            layoutSettings.twoColumns = checked;
            const container = document.getElementById('paper_questions');
            if(checked) container.classList.add('two-columns');
            else container.classList.remove('two-columns');
            saveData();
        }

        function updateWatermark(val) {
            layoutSettings.watermark = val;
            document.getElementById('paper-watermark').innerText = val;
            saveData();
        }

        function applyLayoutSettings() {
            document.getElementById('paper_questions').style.fontSize = layoutSettings.fontSize + 'px';
            const container = document.getElementById('paper_questions');
            if(layoutSettings.twoColumns) {
                container.classList.add('two-columns');
                document.getElementById('toggle-columns').checked = true;
            }
            if(layoutSettings.watermark) {
                document.getElementById('paper-watermark').innerText = layoutSettings.watermark;
                document.getElementById('watermark-text').value = layoutSettings.watermark;
            }
        }

        // --- CLOUD STORAGE ---
        async function saveExamToCloud() {
            if (!window.currentUser) return alert('تکایە پەیوەست بە بە ئینتەرنێتەوە');
            const loading = document.getElementById('pdf-loading');
            document.getElementById('loading-text').innerText = "خەریکی هەڵگرتنی پرسیارەکان...";
            loading.classList.remove('hidden');
            
            try {
                const { db, doc, setDoc, collection, appId } = window.firebaseApp;
                const userId = window.currentUser.uid;
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'exams'), 'currentExam'), {
                    data: examData,
                    layout: layoutSettings,
                    header: {
                        school: document.getElementById('h_school').value,
                        subject: document.getElementById('h_subject').value,
                    },
                    savedAt: new Date().toISOString()
                });
                alert('بە سەرکەوتوویی هەڵگیرا ✓');
            } catch (e) {
                console.error(e);
                alert('هەڵەیەک ڕوویدا لە هەڵگرتن');
            } finally {
                loading.classList.add('hidden');
            }
        }

        async function loadExamFromCloud() {
            if (!window.currentUser) return alert('تکایە پەیوەست بە بە ئینتەرنێتەوە');
            if (!confirm('ئایە دەتەوێت پرسیارە خەزنکراوەکان بێنیتەوە؟ پرسیارەکانی ئێستا دەسڕێنەوە.')) return;
            
            const loading = document.getElementById('pdf-loading');
            document.getElementById('loading-text').innerText = "خەریکی هێنانەوە...";
            loading.classList.remove('hidden');

            try {
                const { db, doc, getDoc, collection, appId } = window.firebaseApp;
                const userId = window.currentUser.uid;
                const snap = await getDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'exams'), 'currentExam'));
                
                if (snap.exists()) {
                    const d = snap.data();
                    examData = d.data || [];
                    if(d.layout) { layoutSettings = d.layout; applyLayoutSettings(); }
                    if(d.header && d.header.school) document.getElementById('h_school').value = d.header.school;
                    saveData();
                    updatePaper();
                    alert('پرسیارەکان هاتنەوە ✓');
                } else {
                    alert('هیچ پرسیارێک خەزن نەکراوە.');
                }
            } catch (e) {
                console.error(e);
                alert('هەڵە ڕوویدا');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- ANSWER KEY GENERATOR ---
        function generateAnswerKey() {
            if(examData.length === 0) return alert('هیچ پرسیارێک نییە');
            
            let html = `
                <html dir="rtl">
                <head>
                    <style>
                        body { font-family: 'Arial', sans-serif; padding: 20px; }
                        h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background-color: #f0f0f0; }
                    </style>
                </head>
                <body>
                    <h1>وەڵامنامەی ${document.getElementById('h_subject').value || 'تاقیکردنەوە'}</h1>
                    <table>
                        <thead><tr><th>ژ</th><th>پرسیار</th><th>وەڵامی ڕاست</th></tr></thead>
                        <tbody>
            `;
            
            let count = 0;
            examData.forEach(item => {
                if(item.type === 'question' && !item.isSub) {
                    count++;
                    const answer = item.correctAnswer || '-';
                    const text = item.text ? item.text.substring(0, 50) : '(وێنە)';
                    html += `<tr><td>${count}</td><td style="text-align:right">${text}</td><td><b>${answer}</b></td></tr>`;
                }
            });
            
            html += `</tbody></table></body></html>`;
            
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.print();
        }

        // --- UPDATED SHUFFLE FEATURE: REMOVES DUPLICATE LABELS ---
        function shuffleMCQAndAnswers() {
            if (!confirm('دڵنیای هەموو هەڵبژاردنەکانی پرسیارەکان تێکەڵ دەکەیت؟\nئەم کارە وەڵامە ڕاستەکانیش دەگۆڕێت بەپێی شوێنی نوێیان.')) return;

            const letterMap = ['A', 'B', 'C', 'D', 'E', 'F'];
            let changesMade = 0;

            examData.forEach(item => {
                if (item.qType === 'mcq' && item.opts) {
                    // 1. Determine current correct index
                    let currentCorrectIndex = -1;
                    const currentAns = (item.correctAnswer || '').trim().toUpperCase();
                    if (letterMap.includes(currentAns)) {
                        currentCorrectIndex = letterMap.indexOf(currentAns);
                    }

                    // 2. Parse existing options into objects & CLEAN PREFIXES
                    let lines = item.opts.split('\n').filter(line => line.trim() !== '');
                    let optionsObjs = lines.map((line, index) => {
                        // Regex to remove A) A. 1) etc.
                        let cleanText = line.replace(/^([A-Z0-9ا-یa-z]+)[\)\.-]\s+/, '').trim();
                        // Fallback if no space matched but has prefix
                        cleanText = cleanText.replace(/^[A-Z0-9ا-یa-z]+[\)\.-]/, '').trim();

                        return {
                            text: cleanText,
                            isCorrect: (index === currentCorrectIndex)
                        };
                    });

                    // 3. Shuffle logic (Fisher-Yates)
                    for (let i = optionsObjs.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [optionsObjs[i], optionsObjs[j]] = [optionsObjs[j], optionsObjs[i]];
                    }

                    // 4. Reconstruct options string and find new correct answer
                    let newOptsString = "";
                    let newCorrectAnswer = item.correctAnswer; 

                    optionsObjs.forEach((opt, index) => {
                        let letter = letterMap[index] || (index + 1);
                        // We add the prefix back here freshly
                        newOptsString += `${letter}) ${opt.text}\n`;
                        
                        // If this option was the correct one, update the answer key
                        if (opt.isCorrect) {
                            newCorrectAnswer = letter;
                        }
                    });

                    item.opts = newOptsString;
                    item.correctAnswer = newCorrectAnswer;
                    changesMade++;
                }
            });

            if (changesMade > 0) {
                saveData();
                renderQuestions();
                alert(`سەرکەوتوو بوو! ${changesMade} پرسیار هەڵبژاردنەکانیان تێکەڵ کرا.`);
            } else {
                alert('هیچ پرسیارێکی هەڵبژاردن نەدۆزرایەوە.');
            }
        }

        // --- WORD EXPORT ---
        function downloadWord() {
            const headerContent = document.querySelector('.exam-header').outerHTML;
            const questionsContent = document.getElementById('paper_questions').innerHTML;
            const watermark = layoutSettings.watermark ? `<div style="text-align:center;color:#eee;font-size:50pt;position:absolute;z-index:-1;">${layoutSettings.watermark}</div>` : '';

            const html = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40' dir="rtl">
                <head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title>
                <style>
                    body { font-family: 'Arial', sans-serif; }
                    .exam-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; }
                    .q-number { background: #000; color: #fff; padding: 2px 5px; border-radius: 50%; }
                </style>
                </head><body>
                ${watermark}
                ${headerContent}
                ${questionsContent}
                </body></html>
            `;

            const blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });
            
            const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
            const link = document.createElement("a");
            document.body.appendChild(link);
            if (navigator.msSaveOrOpenBlob) {
                navigator.msSaveOrOpenBlob(blob, 'exam.doc');
            } else {
                link.href = url;
                link.download = "exam.doc";
                link.click();
            }
            document.body.removeChild(link);
        }

        // --- DUPLICATE ---
        function duplicateItem(index) {
            const item = JSON.parse(JSON.stringify(examData[index])); 
            item.id = Date.now();
            examData.splice(index + 1, 0, item);
            saveData();
        }

        // --- CRUD & UI ---
        function addItemDesktop() {
            const type = currentMode;
            if (type === 'question') {
                const text = document.getElementById('q_text').value;
                const score = document.getElementById('q_score').value;
                const qType = document.getElementById('q_type').value;
                const isSub = document.getElementById('q_is_sub').checked;
                const subStyle = document.getElementById('q_sub_style').value;
                const spacing = document.getElementById('q_spacing').value;
                const fileInput = document.getElementById('q_image');
                const opts = document.getElementById('q_mcq_opts').value;
                const answer = document.getElementById('q_answer').value;

                if (!text && !fileInput.files[0] && editIndex === -1) return alert('تکایە دەق یان وێنە دابنێ');

                const itemData = {
                    id: (editIndex > -1) ? examData[editIndex].id : Date.now(),
                    type: 'question',
                    text, score, qType, isSub, subStyle, spacing, opts,
                    correctAnswer: answer,
                    img: (editIndex > -1) ? examData[editIndex].img : null
                };

                const finalize = () => {
                     if (editIndex > -1) { examData[editIndex] = itemData; } 
                     else { examData.push(itemData); }
                     saveData();
                     resetEditMode();
                };

                if (fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) { itemData.img = e.target.result; finalize(); };
                    reader.readAsDataURL(fileInput.files[0]);
                } else { finalize(); }
            }
        }

        function addTitleItem() {
            const text = document.getElementById('t_text').value;
            if (!text) return;
            const itemData = { id: Date.now(), type: 'title', text };
            examData.push(itemData);
            saveData();
            document.getElementById('t_text').value = '';
        }

        function editItem(index) {
            editIndex = index;
            const item = examData[index];
            switchMode('question', 'desktop');
            
            if (item.type === 'question') {
                document.getElementById('q_text').value = item.text || '';
                document.getElementById('q_score').value = item.score || 2;
                document.getElementById('q_type').value = item.qType;
                document.getElementById('q_is_sub').checked = item.isSub || false;
                document.getElementById('q_spacing').value = item.spacing || 0;
                document.getElementById('q_mcq_opts').value = item.opts || '';
                document.getElementById('q_answer').value = item.correctAnswer || '';
                toggleSubOptions('desktop');
                toggleMCQ(item.qType, 'desktop');
                document.getElementById('desk-add-btn').innerText = "تۆمارکردنی گۆڕانکاری";
                document.getElementById('desk-add-btn').classList.replace('bg-blue-600', 'bg-green-600');
            }
        }

        function resetEditMode() {
            editIndex = -1;
            document.getElementById('desk-add-btn').innerText = "زیادکردن";
            document.getElementById('desk-add-btn').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('q_text').value = '';
            document.getElementById('q_image').value = '';
            document.getElementById('q_mcq_opts').value = '';
            document.getElementById('q_answer').value = '';
        }

        function renderQuestions() {
            const container = document.getElementById('paper_questions');
            const miniList = document.getElementById('questions_mini_list');
            container.innerHTML = '';
            miniList.innerHTML = '';

            let mainQCounter = 0;
            let subQCounter = 0;
            let lastMainType = null;

            examData.forEach((item, index) => {
                const miniItem = document.createElement('div');
                miniItem.className = 'bg-gray-100 p-2 rounded flex justify-between items-center group shadow-sm';
                const miniText = item.type === 'title' ? `<b>[سەردێڕ]</b> ${item.text}` : (item.text ? item.text.substring(0, 20) + '...' : '[وێنە]');
                
                miniItem.innerHTML = `
                    <span class="drag-handle cursor-grab px-2 text-gray-400"><i class="fa-solid fa-grip-vertical"></i></span>
                    <span class="flex-1 text-right text-xs truncate">${miniText}</span>
                    <div class="flex gap-1">
                        <button onclick="duplicateItem(${index})" class="text-gray-500 hover:text-blue-500 px-1" title="کۆپی"><i class="fa-solid fa-copy"></i></button>
                        <button onclick="editItem(${index})" class="text-blue-500 hover:text-blue-700 px-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteItem(${index})" class="text-red-500 hover:text-red-700 px-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                miniList.appendChild(miniItem);

                // Preview Logic
                const div = document.createElement('div');
                if (item.type === 'title') {
                    div.className = 'section-title';
                    div.innerHTML = item.text;
                } else {
                    div.className = 'w-full mb-2 break-inside-avoid';
                    if (!item.isSub) {
                        if (item.qType !== lastMainType) { mainQCounter = 0; lastMainType = item.qType; }
                        mainQCounter++; subQCounter = 0; 
                    } else { subQCounter++; }

                    let labelHTML = item.isSub 
                        ? `<span class="q-sub-number">${item.subStyle === 'number' ? subQCounter : (['A','B','C'][subQCounter-1] || subQCounter)}</span>`
                        : `<span class="q-number">${mainQCounter}</span>`;

                    let contentHTML = `<div class="flex items-start w-full">
                        ${labelHTML}
                        <div class="flex-1">
                            <div class="font-bold text-right text-lg leading-relaxed mb-1 q-content" dir="auto">${item.text}</div>
                            ${item.img ? `<img src="${item.img}" class="q-image" alt="Question Image">` : ''}
                            ${renderMCQOptions(item)}
                        </div>
                        ${item.isSub ? '' : `<span class="q-score">${item.score} نمرە</span>`}
                    </div>`;
                    
                    if (item.spacing > 0) contentHTML += `<div style="height: ${item.spacing}mm"></div>`;
                    div.innerHTML = contentHTML;
                }
                container.appendChild(div);
            });
            
            applyLayoutSettings();
            if (window.MathJax) MathJax.typesetPromise([container]);
        }

        // --- UPDATED RENDER MCQ: STRIPS PREFIXES FROM DISPLAY ---
        function renderMCQOptions(item) {
            let options = [];
            if (item.qType === 'mcq' && item.opts) options = item.opts.split('\n').filter(o => o.trim());
            else if (item.qType === 'tf') options = ['ڕاست', 'هەڵە'];
            
            if (options.length === 0) return '';
            let gridClass = (options.some(o => o.length > 30)) ? 'grid-cols-1' : (options.every(o => o.length < 10) ? 'grid-cols-4' : 'grid-cols-2');
            
            let html = `<div class="grid ${gridClass} gap-y-2 gap-x-8 mt-2 w-full pr-4">`;
            options.forEach((optRaw, index) => {
                const label = (item.qType === 'tf') ? '' : (['A','B','C','D'][index] || index+1) + ')';
                
                // CLEAN THE OPTION TEXT BEFORE DISPLAYING
                // If text comes as "A) Apple", we only want "Apple" because we add the label ourselves
                let cleanOpt = optRaw;
                if(item.qType === 'mcq') {
                     cleanOpt = optRaw.replace(/^([A-Z0-9ا-یa-z]+)[\)\.-]\s+/, '').trim();
                     cleanOpt = cleanOpt.replace(/^[A-Z0-9ا-یa-z]+[\)\.-]/, '').trim();
                }

                html += `<div class="text-right flex items-baseline gap-2" dir="auto">
                    ${label ? `<span class="font-bold font-sans">${label}</span>` : ''}
                    <span>${cleanOpt}</span>
                </div>`;
            });
            html += '</div>';
            return html;
        }

        function deleteItem(index) { if(confirm('دڵنیای؟')) { examData.splice(index, 1); saveData(); resetEditMode(); } }
        function clearAll() { if(confirm('هەمووی دەسڕیتەوە؟')) { examData = []; saveData(); resetEditMode(); } }

        function toggleSubOptions(view) {
            const isSub = document.getElementById('q_is_sub').checked;
            document.getElementById('q_sub_style').classList.toggle('hidden', !isSub);
        }
        function toggleMCQ(val, view) {
            document.getElementById('mcq_options_container').classList.toggle('hidden', val !== 'mcq');
        }

        function switchMode(mode) {
            document.getElementById('desk-mode-q').className = mode === 'question' ? 'mode-btn active' : 'mode-btn inactive';
            document.getElementById('desk-mode-s').className = mode === 'settings' ? 'mode-btn active' : 'mode-btn inactive';
            document.getElementById('desk-input-question').classList.toggle('hidden', mode !== 'question');
            document.getElementById('desk-input-settings').classList.toggle('hidden', mode !== 'settings');
        }

        // Setup Helpers
        new Sortable(document.getElementById('questions_mini_list'), { animation: 150, handle: '.drag-handle', onEnd: function (evt) { const item = examData.splice(evt.oldIndex, 1)[0]; examData.splice(evt.newIndex, 0, item); saveData(); }});
        
        // Modal functions removed as they are integrated into settings/preview now
        // But keeping Video Modal
        function openVideoModal() { document.getElementById('video-modal').classList.remove('hidden'); }
        function closeVideoModal() { document.getElementById('video-modal').classList.add('hidden'); document.getElementById('tutorial-video-frame').src = document.getElementById('tutorial-video-frame').src; }
        
        function downloadDirectPDF() {
            const element = document.getElementById('examPaper');
            const loading = document.getElementById('pdf-loading');
            loading.classList.remove('hidden');
            element.style.transform = 'none'; element.style.margin = '0';
            const opt = { margin: 0, filename: 'Exam_Paper.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save().then(() => { loading.classList.add('hidden'); updatePaper(); }).catch(err => { console.error(err); loading.classList.add('hidden'); });
        }

        function updatePaper() { 
            // Reflect header inputs to view
            ['school','subject','class','time','date','dir','gov','type','year','group'].forEach(f => {
                const el = document.getElementById('h_'+f);
                const view = document.getElementById('view_'+f);
                if(el && view) {
                    view.innerText = el.value;
                    localStorage.setItem('h_'+f, el.value); // Save instantly
                }
            });
            const sub2 = document.getElementById('view_subject_2');
            if(sub2) sub2.innerText = document.getElementById('h_subject').value;
            applyLayoutSettings();
        }
        
        // Logo Listener
        document.getElementById('h_logo_input').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    document.getElementById('header_logo_img').src = evt.target.result;
                    localStorage.setItem('header_logo', evt.target.result);
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        function switchTab(tab) {
            const editor = document.getElementById('editor-panel');
            const preview = document.getElementById('preview-panel');
            const btnEd = document.getElementById('btn-editor');
            const btnPr = document.getElementById('btn-preview');
            
            // Toggle visibility
            if (tab === 'editor') { 
                editor.classList.remove('hidden'); 
                editor.classList.add('block');
                preview.classList.add('hidden');
                preview.classList.remove('block');
                
                // Active State for Editor Btn
                btnEd.classList.add('border-t-2', 'border-blue-600', 'bg-blue-50', 'text-blue-600');
                btnEd.classList.remove('text-gray-500');
                
                // Inactive State for Preview Btn
                btnPr.classList.remove('border-t-2', 'border-blue-600', 'bg-blue-50', 'text-blue-600');
                btnPr.classList.add('text-gray-500');
            }
            else { 
                editor.classList.add('hidden'); 
                editor.classList.remove('block');
                preview.classList.remove('hidden');
                preview.classList.add('block');
                
                // Active State for Preview Btn
                btnPr.classList.add('border-t-2', 'border-blue-600', 'bg-blue-50', 'text-blue-600');
                btnPr.classList.remove('text-gray-500');
                
                // Inactive State for Editor Btn
                btnEd.classList.remove('border-t-2', 'border-blue-600', 'bg-blue-50', 'text-blue-600');
                btnEd.classList.add('text-gray-500');
            }
        }

        const savedCode = localStorage.getItem('exam_app_code');
        if (savedCode) { document.getElementById('login-overlay').style.display = 'none'; loadData(); }
    </script>
</body>
</html>
