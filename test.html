<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بەڕێوەبەری کۆدەکان (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nrt+Reg&family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'Arial'], nrt: ['Nrt Reg', 'Arial'] },
                    colors: { admin: { 50: '#f5f3ff', 600: '#7c3aed', 700: '#6d28d9', 900: '#4c1d95' } }
                }
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // هەمان کۆنفیگی بەرنامەکەی تر
        const firebaseConfig = {
            apiKey: "AIzaSyBHxuOA6uuX1EZGse5_JOHc3WMjvPywLD4",
            authDomain: "prsyar-c93dd.firebaseapp.com",
            projectId: "prsyar-c93dd",
            storageBucket: "prsyar-c93dd.firebasestorage.app",
            messagingSenderId: "623772510800",
            appId: "1:623772510800:web:cc49fc9bbd9ed9c170ff55",
            measurementId: "G-7KLKMNVFHC"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // دەبێت هەمان ئایدی بێت کە لە بەرنامەکەی تر بەکارت هێناوە
            const appId = 'exam-system-v11-secure'; 

            window.firebaseApp = { db, appId, doc, setDoc, deleteDoc, collection, getDocs, query, orderBy };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Connected to Firebase");
                    document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                } else {
                    signInAnonymously(auth);
                }
            });

        } catch (e) {
            console.error("Firebase Error", e);
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="login-screen" class="fixed inset-0 bg-admin-900 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <div class="mb-4 text-6xl text-admin-600"><i class="fa-solid fa-user-shield"></i></div>
            <h1 class="text-2xl font-bold mb-2">بەڕێوەبەری کۆدەکان</h1>
            <p class="text-gray-500 mb-6 text-sm">تکایە پاسۆردی ئەدمین بنووسە</p>
            
            <input type="password" id="admin-pass" class="w-full p-3 border-2 border-gray-300 rounded-xl text-center text-lg mb-4 focus:border-admin-600 outline-none" placeholder="پاسۆرد...">
            <button onclick="adminLogin()" class="w-full bg-admin-600 hover:bg-admin-700 text-white font-bold py-3 rounded-xl transition">چوونەژوورەوە</button>
        </div>
    </div>

    <div id="dashboard" class="hidden min-h-screen">
        <header class="bg-admin-900 text-white p-4 shadow-lg flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shield-halved text-2xl"></i>
                <div>
                    <h1 class="font-bold text-lg">کۆنترۆڵی کۆدەکان</h1>
                    <div class="flex items-center gap-1 text-xs text-gray-300">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                        پەیوەستە بە داتابەیس
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded text-sm transition">چوونەدەرەوە</button>
        </header>

        <div class="container mx-auto p-4 max-w-4xl">
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-6 border-t-4 border-admin-600">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-plus-circle text-admin-600"></i> دروستکردنی کۆدی نوێ
                </h2>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex-1 relative">
                        <input type="number" id="new-code" class="w-full p-3 border rounded-lg text-left font-mono font-bold text-lg tracking-widest pl-10" placeholder="کۆد (6-10 ژمارە)">
                        <button onclick="generateRandomCode()" class="absolute left-2 top-2 text-gray-400 hover:text-admin-600 p-1" title="کۆدی هەڕەمەکی">
                            <i class="fa-solid fa-shuffle"></i>
                        </button>
                    </div>
                    <input type="text" id="code-note" class="flex-1 p-3 border rounded-lg" placeholder="تێبینی (بۆ کێیە؟)">
                    <button onclick="saveCode()" class="bg-admin-600 hover:bg-admin-700 text-white font-bold px-6 py-3 rounded-lg shadow transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-save"></i> دروستکردن
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">لیستی کۆدە چالاکەکان</h2>
                    <button onclick="loadCodes()" class="text-admin-600 hover:bg-admin-50 px-2 py-1 rounded"><i class="fa-solid fa-rotate"></i> نوێکردنەوە</button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="p-4">کۆد</th>
                                <th class="p-4">خاوەن / تێبینی</th>
                                <th class="p-4">بەرواری دروستکردن</th>
                                <th class="p-4 text-center">کردار</th>
                            </tr>
                        </thead>
                        <tbody id="codes-table-body" class="divide-y divide-gray-100 text-sm">
                            <tr><td colspan="4" class="p-6 text-center text-gray-400">خەریکی هێنانەوەی داتایە...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- ADMIN LOGIN ---
        function adminLogin() {
            const pass = document.getElementById('admin-pass').value;
            // ئەمە پاسۆردی تۆیە بۆ چوونە ناو ئەم بەرنامەیە
            if (pass === '11223344009') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadCodes();
            } else {
                alert('پاسۆرد هەڵەیە!');
            }
        }

        function logout() {
            location.reload();
        }

        // --- GENERATE RANDOM CODE ---
        function generateRandomCode() {
            // Generate 8 digit random number
            const random = Math.floor(10000000 + Math.random() * 90000000);
            document.getElementById('new-code').value = random;
        }

        // --- FIREBASE OPERATIONS ---
        
        // 1. SAVE CODE
        async function saveCode() {
            const codeInput = document.getElementById('new-code');
            const noteInput = document.getElementById('code-note');
            const code = codeInput.value.trim();
            const note = noteInput.value.trim() || 'بێ تێبینی';

            if (code.length < 6) return alert('کۆد دەبێت لانی کەم ٦ ژمارە بێت');

            const { db, setDoc, doc, appId } = window.firebaseApp;
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Save to: artifacts -> exam-system-v11-secure -> access_codes -> [CODE]
                await setDoc(doc(db, 'artifacts', appId, 'access_codes', code), {
                    active: true,
                    note: note,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Admin Panel'
                });

                alert(`کۆدی ${code} بە سەرکەوتوویی زیادکرا.`);
                codeInput.value = '';
                noteInput.value = '';
                loadCodes(); // Refresh list

            } catch (error) {
                console.error(error);
                alert('هەڵەیەک ڕوویدا لە کاتی پەیوەستبوون.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 2. LOAD CODES
        async function loadCodes() {
            const { db, collection, getDocs, appId } = window.firebaseApp;
            const tbody = document.getElementById('codes-table-body');
            
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'access_codes'));
                
                tbody.innerHTML = '';
                
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">هیچ کۆدێک نەدۆزرایەوە.</td></tr>';
                    return;
                }

                snap.forEach(docSnap => {
                    const code = docSnap.id;
                    const data = docSnap.data();
                    const date = data.createdAt ? new Date(data.createdAt).toLocaleDateString('ckb') : '-';

                    const row = `
                        <tr class="hover:bg-gray-50 transition group">
                            <td class="p-4 font-mono font-bold text-admin-700 text-lg select-all cursor-pointer" onclick="copyToClipboard('${code}')">
                                ${code} <i class="fa-regular fa-copy text-gray-300 text-xs ml-2 group-hover:text-gray-500"></i>
                            </td>
                            <td class="p-4 font-medium">${data.note}</td>
                            <td class="p-4 text-gray-500">${date}</td>
                            <td class="p-4 text-center">
                                <button onclick="deleteCode('${code}')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded text-xs font-bold transition">
                                    <i class="fa-solid fa-trash"></i> سڕینەوە
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-red-500">هەڵە لە هێنانی داتاکان.</td></tr>';
            }
        }

        // 3. DELETE CODE
        async function deleteCode(code) {
            if(!confirm(`دڵنیای لە سڕینەوەی کۆدی [ ${code} ]؟\nئیتر کەس ناتوانێت بەم کۆدە بچێتە ژوورەوە.`)) return;

            const { db, deleteDoc, doc, appId } = window.firebaseApp;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'access_codes', code));
                loadCodes(); // Refresh
            } catch (error) {
                alert('هەڵە ڕوویدا');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('کۆدەکە کۆپی کرا: ' + text);
        }

    </script>
</body>
</html>
